# Agent Notes (Marimo Notebooks)

This repo contains marimo notebooks designed for public/brand‑ready presentation and export to GitHub Pages. Follow these conventions to keep notebooks robust, accessible, and compliant.

## Always Run Checks
- Run `uv run marimo check notebooks/` (or `marimo check notebooks/`) before handing off changes. (This avoids non-notebook Python files like tests/.)
- Fix all `critical[multiple-definitions]` issues. Variables must be unique across cells. Use underscore‑prefixed locals (e.g., `_i`, `_col`, `_tmp`) for loop indices/scratch variables.
- Run a syntax check: `python3 -m py_compile <notebook>.py`.

## Marimo Coding Patterns
- Do NOT access `.value` of a UI element in the same cell that creates it. Create UI in one cell, consume values in a downstream cell.
- Avoid cross‑cell name collisions. If a variable name appears in multiple cells at top level, give each cell unique names or underscore locals.
- Avoid in‑place mutation of shared arrays/dataframes across cells. Build new objects per cell.
- Keep heavy compute behind a “Run” button. Don’t auto‑simulate on every slider change.
- Import pattern to avoid lints: top‑level `import marimo`, then in the first cell `import marimo; mo = marimo` to provide `mo` while avoiding alias warnings.

## UI/UX Conventions
- Dual track: “English mode (simple)” vs “Nerd mode (detailed)”.
  - English mode shows only essential inputs: Current Value, Annual Savings, Years, Risk Level (or Custom), Years until withdrawal, and Scenario highlight.
  - Nerd mode reveals regimes, block bootstrap, distributions, log scale, band toggles, density controls, target value, etc.
- Add a “Run simulation” button and a “Reset” button. Render charts only after the run is pressed. Compare run vs reset counts to gate computation.
- Required disclaimer gate at the top; no simulation until acknowledged.
- Scenario highlight radio: Conservative (25th), Median (50th), Optimistic (75th). Highlight the chosen line on the fan chart.
- Temporary withdrawal (“bridge”): start in N years, duration Y years, rate %. During the bridge, apply withdrawals and skip contributions.

## Simulation Engine Defaults
- Sampling: Student t distribution (fat tails) by default; allow Normal.
- Optional regimes: Fixed or Dynamic (Markov) with stay probabilities.
- Optional block bootstrap: circular blocks (3–12 months). Use 3 months by default in English mode.
- Fees: base AUM fee + weighted sub‑manager fees; apply monthly.
- Run gating: simulation should return a friendly message until inputs are valid and Run is pressed.

## Branding & Accessibility
- Read brand palette from `Ethical-Capital-Brand-Kit/palette/palette.json`. Provide fallbacks if unavailable.
- Apply brand colors universally:
  - Fan chart: median = primary, mean = accent, percentile edge lines = muted, bands = muted RGBA fills, paths = light gray.
  - Histogram: bars = accent, percentile lines = muted, target line = primary.
  - CDF: curve = accent, target = primary.
  - Survival/TTD: line = accent, fills/bars = brand fills/warning.
- Use colorblind‑safe defaults; avoid red/green contrasts.

## Downloads/Exports
- Prefer data‑URI download links for CSV (compat across marimo versions). Avoid `mo.ui.download` unless known to exist.
- Provide “Export all (zip)” with percentiles.csv, final_values.csv, and sample_paths.csv.

## GitHub Pages Publishing
- Source notebooks live in `notebooks/`.
- CI workflow (`.github/workflows/publish.yml`) exports all notebooks to `docs/*.html` via `marimo export` and deploys to Pages.
- The Pages index (`docs/index.html`) is generated by the workflow and includes a master disclaimer at the top and links to each notebook.
- One‑time repo config: Settings → Pages → Source = GitHub Actions.

## Disclaimers & Compliance
- Notebook gate: show a clear “For illustrative purposes only” disclaimer and require an explicit acknowledgement.
- Pages home: include the master “IMPORTANT NOTICE AND DISCLAIMER” section.
- Use “illustrative/possible” language. Avoid “expected”/“prediction” phrasing.

## Troubleshooting (per marimo docs)
- Run with debug logging to get Python stack traces: `uvx --with numpy --with pandas --with plotly marimo run notebooks/<file>.py --log-level debug --no-browser`.
- If frontend shows “internal error”, check backend logs for a cell traceback.
- Common fixes:
  - Remove empty UI containers (avoid rendering `mo.hstack([])`).
  - Split any cell that both creates and reads a UI `.value`.
  - Eliminate cross‑cell name collisions (use `_name` for locals).
  - Guard all visualizations behind simulation results and run gating.

## Local Dev (uv)
- Use PEP‑723 inline deps at the top of notebooks when appropriate. Prefer `uv run` or `uvx marimo` to avoid venv sprawl.
- Example: `uvx --with numpy --with pandas --with plotly marimo run notebooks/portfolio_growth_simulator.py`.

## Adding a New Notebook
1) `marimo create notebooks/my_notebook.py`
2) Follow the patterns above (gate with Run, English vs Nerd, brand cell, disclaimers).
3) `uv run marimo check .` and `python3 -m py_compile notebooks/my_notebook.py`
4) Commit and push to `main` to publish via Pages.
