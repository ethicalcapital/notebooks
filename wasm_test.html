<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>portfolio growth simulator</title>
    <script type="module" crossorigin src="./assets/index-C7CoaNFb.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-DadI618h.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="">import%20marimo%0A%0A__generated_with%20%3D%20%220.16.1%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%0A%20%20%20%20mo%20%3D%20marimo%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20%23%20Import%20plotly%20at%20the%20top%20level%20so%20WASM%20export%20infers%20the%20correct%20package%20name%0A%20%20%20%20import%20plotly%20as%20_plotly%0A%20%20%20%20go%20%3D%20_plotly.graph_objects%0A%20%20%20%20import%20warnings%0A%0A%20%20%20%20warnings.filterwarnings(%22ignore%22)%0A%20%20%20%20return%20go%2C%20mo%2C%20np%2C%20pd%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%20%F0%9F%8E%AF%20Portfolio%20Growth%20Simulator%20with%20Monte%20Carlo%20Analysis%0A%0A%20%20%20%20This%20interactive%20tool%20helps%20you%20visualize%20how%20your%20investment%20portfolio%20might%20grow%20over%20time%2C%0A%20%20%20%20considering%20the%20sequence%20of%20returns%20risk%20through%20Monte%20Carlo%20simulation.%0A%0A%20%20%20%20%23%23%20%F0%9F%93%8A%20Configure%20Your%20Portfolio%20Below%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20annual_savings%2C%0A%20%20%20%20asset_params%2C%0A%20%20%20%20base_fee_all%2C%0A%20%20%20%20block_len%2C%0A%20%20%20%20bridge_duration_years%2C%0A%20%20%20%20bridge_enable%2C%0A%20%20%20%20bridge_rate%2C%0A%20%20%20%20bridge_start_years%2C%0A%20%20%20%20current_value%2C%0A%20%20%20%20diversified_pct%2C%0A%20%20%20%20fixed_regime%2C%0A%20%20%20%20growth_pct%2C%0A%20%20%20%20income_pct%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20num_simulations%2C%0A%20%20%20%20p_stay_bear%2C%0A%20%20%20%20p_stay_bull%2C%0A%20%20%20%20p_stay_normal%2C%0A%20%20%20%20random_seed%2C%0A%20%20%20%20regime_mode%2C%0A%20%20%20%20return_dist%2C%0A%20%20%20%20sampling_method%2C%0A%20%20%20%20sub_fee_diversified%2C%0A%20%20%20%20sub_fee_income%2C%0A%20%20%20%20t_df%2C%0A%20%20%20%20total_allocation%2C%0A%20%20%20%20use_regime%2C%0A%20%20%20%20withdrawal_rate%2C%0A%20%20%20%20withdrawal_start_year%2C%0A%20%20%20%20years_to_simulate%2C%0A)%3A%0A%20%20%20%20cfg%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22years%22%3A%20int(years_to_simulate.value)%2C%0A%20%20%20%20%20%20%20%20%22n_sims%22%3A%20int(num_simulations.value)%2C%0A%20%20%20%20%20%20%20%20%22initial%22%3A%20float(current_value.value)%2C%0A%20%20%20%20%20%20%20%20%22monthly%22%3A%20float(annual_savings.value)%20%2F%2012.0%2C%0A%20%20%20%20%20%20%20%20%22seed%22%3A%20int(random_seed.value)%20if%20random_seed.value%20is%20not%20None%20else%2042%2C%0A%20%20%20%20%20%20%20%20%22weights%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22growth%22%3A%20float(growth_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22diversified%22%3A%20float(diversified_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22income%22%3A%20float(income_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22fees%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22base%22%3A%20float(base_fee_all.value)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22sub_div%22%3A%20float(sub_fee_diversified.value)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22sub_inc%22%3A%20float(sub_fee_income.value)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22regimes%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22use%22%3A%20bool(use_regime.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22mode%22%3A%20str(regime_mode.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22fixed%22%3A%20str(fixed_regime.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22p_stay%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bull%22%3A%20float(p_stay_bull.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22normal%22%3A%20float(p_stay_normal.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22bear%22%3A%20float(p_stay_bear.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22sampling%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22method%22%3A%20str(sampling_method.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22dist%22%3A%20str(return_dist.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22t_df%22%3A%20int(t_df.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22block_len%22%3A%20int(block_len.value)%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22withdrawals%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22start_year%22%3A%20int(withdrawal_start_year.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22rate%22%3A%20float(withdrawal_rate.value)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22bridge%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22enable%22%3A%20bool(bridge_enable.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22start%22%3A%20int(bridge_start_years.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22duration%22%3A%20int(bridge_duration_years.value)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22rate%22%3A%20float(bridge_rate.value)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22inflation%22%3A%20float(inflation_rate.value)%20%2F%20100.0%2C%0A%20%20%20%20%7D%0A%20%20%20%20err%20%3D%20None%0A%20%20%20%20%23%20Basic%20validation%20(UI-only).%20Full%20gating%20stays%20in%20compute%20cell.%0A%20%20%20%20if%20total_allocation%20!%3D%20100%3A%0A%20%20%20%20%20%20%20%20err%20%3D%20%22Allocations%20must%20sum%20to%20100%25.%22%0A%20%20%20%20elif%20cfg%5B%22years%22%5D%20%3C%3D%200%3A%0A%20%20%20%20%20%20%20%20err%20%3D%20%22Years%20to%20simulate%20must%20be%20at%20least%201.%22%0A%20%20%20%20elif%20cfg%5B%22n_sims%22%5D%20%3C%3D%200%3A%0A%20%20%20%20%20%20%20%20err%20%3D%20%22Number%20of%20simulations%20must%20be%20positive.%22%0A%20%20%20%20elif%20cfg%5B%22initial%22%5D%20%3C%200%3A%0A%20%20%20%20%20%20%20%20err%20%3D%20%22Initial%20investment%20cannot%20be%20negative.%22%0A%20%20%20%20elif%20cfg%5B%22monthly%22%5D%20%3C%200%3A%0A%20%20%20%20%20%20%20%20err%20%3D%20%22Monthly%20contribution%20cannot%20be%20negative.%22%0A%20%20%20%20if%20cfg%5B%22seed%22%5D%20%3C%200%3A%0A%20%20%20%20%20%20%20%20cfg%5B%22seed%22%5D%20%3D%20abs(cfg%5B%22seed%22%5D)%0A%20%20%20%20if%20cfg%5B%22sampling%22%5D%5B%22dist%22%5D%20%3D%3D%20%22Student%20t%22%20and%20cfg%5B%22sampling%22%5D%5B%22t_df%22%5D%20%3C%203%3A%0A%20%20%20%20%20%20%20%20cfg%5B%22sampling%22%5D%5B%22t_df%22%5D%20%3D%203%0A%20%20%20%20if%20cfg%5B%22sampling%22%5D%5B%22block_len%22%5D%20%3C%201%3A%0A%20%20%20%20%20%20%20%20cfg%5B%22sampling%22%5D%5B%22block_len%22%5D%20%3D%201%0A%0A%20%20%20%20assets%20%3D%20%7Bk%3A%20%7B%22mean%22%3A%20float(v%5B%22mean_return%22%5D)%2C%20%22vol%22%3A%20float(v%5B%22volatility%22%5D)%7D%20for%20k%2C%20v%20in%20asset_params.items()%7D%0A%20%20%20%20return%20assets%2C%20cfg%2C%20err%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20functools%20import%20lru_cache%0A%20%20%20%20import%20json%20as%20_json%0A%20%20%20%20import%20numpy%20as%20_np%0A%20%20%20%20import%20pandas%20as%20_pd%0A%0A%20%20%20%20%40lru_cache(maxsize%3D64)%0A%20%20%20%20def%20simulate_portfolio_cached(config_json%3A%20str%2C%20assets_json%3A%20str)%3A%0A%20%20%20%20%20%20%20%20cfg%20%3D%20_json.loads(config_json)%0A%20%20%20%20%20%20%20%20assets%20%3D%20_json.loads(assets_json)%0A%0A%20%20%20%20%20%20%20%20weights%20%3D%20cfg%5B%22weights%22%5D%0A%20%20%20%20%20%20%20%20p_return%20%3D%20sum(weights%5Ba%5D%20*%20assets%5Ba%5D%5B%22mean%22%5D%20for%20a%20in%20weights)%0A%20%20%20%20%20%20%20%20p_vol%20%3D%20(_np.sqrt(sum((weights%5Ba%5D%20*%20assets%5Ba%5D%5B%22vol%22%5D)%20**%202%20for%20a%20in%20weights)))%0A%0A%20%20%20%20%20%20%20%20years%20%3D%20cfg%5B%22years%22%5D%0A%20%20%20%20%20%20%20%20n_sims%20%3D%20cfg%5B%22n_sims%22%5D%0A%20%20%20%20%20%20%20%20initial%20%3D%20cfg%5B%22initial%22%5D%0A%20%20%20%20%20%20%20%20monthly%20%3D%20cfg%5B%22monthly%22%5D%0A%20%20%20%20%20%20%20%20seed%20%3D%20cfg%5B%22seed%22%5D%0A%0A%20%20%20%20%20%20%20%20months%20%3D%20years%20*%2012%0A%20%20%20%20%20%20%20%20results%20%3D%20_np.zeros((n_sims%2C%20months%20%2B%201)%2C%20dtype%3Dfloat)%0A%20%20%20%20%20%20%20%20results%5B%3A%2C%200%5D%20%3D%20initial%0A%20%20%20%20%20%20%20%20_np.random.seed(seed)%0A%0A%20%20%20%20%20%20%20%20monthly_fee_rate%20%3D%20cfg%5B%22fees%22%5D%5B%22base%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20monthly_fee_rate%20%2B%3D%20weights%5B%22diversified%22%5D%20*%20(cfg%5B%22fees%22%5D%5B%22sub_div%22%5D)%20%2F%2012.0%0A%20%20%20%20%20%20%20%20monthly_fee_rate%20%2B%3D%20weights%5B%22income%22%5D%20*%20(cfg%5B%22fees%22%5D%5B%22sub_inc%22%5D)%20%2F%2012.0%0A%0A%20%20%20%20%20%20%20%20regime_multipliers%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Bull%22%3A%20%7B%22mean%22%3A%201.25%2C%20%22vol%22%3A%200.85%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Normal%22%3A%20%7B%22mean%22%3A%201.00%2C%20%22vol%22%3A%201.00%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Bear%22%3A%20%7B%22mean%22%3A%200.60%2C%20%22vol%22%3A%201.30%7D%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20base_m_mean%20%3D%20p_return%20%2F%2012.0%0A%20%20%20%20%20%20%20%20base_m_sigma%20%3D%20p_vol%20%2F%20_np.sqrt(12.0)%0A%0A%20%20%20%20%20%20%20%20use_reg%20%3D%20cfg%5B%22regimes%22%5D%5B%22use%22%5D%0A%20%20%20%20%20%20%20%20reg_mode%20%3D%20cfg%5B%22regimes%22%5D%5B%22mode%22%5D%0A%20%20%20%20%20%20%20%20fixed%20%3D%20cfg%5B%22regimes%22%5D%5B%22fixed%22%5D%0A%20%20%20%20%20%20%20%20p_bull%20%3D%20cfg%5B%22regimes%22%5D%5B%22p_stay%22%5D%5B%22bull%22%5D%0A%20%20%20%20%20%20%20%20p_norm%20%3D%20cfg%5B%22regimes%22%5D%5B%22p_stay%22%5D%5B%22normal%22%5D%0A%20%20%20%20%20%20%20%20p_bear%20%3D%20cfg%5B%22regimes%22%5D%5B%22p_stay%22%5D%5B%22bear%22%5D%0A%0A%20%20%20%20%20%20%20%20samp_method%20%3D%20cfg%5B%22sampling%22%5D%5B%22method%22%5D%0A%20%20%20%20%20%20%20%20dist_choice%20%3D%20cfg%5B%22sampling%22%5D%5B%22dist%22%5D%0A%20%20%20%20%20%20%20%20dfv%20%3D%20cfg%5B%22sampling%22%5D%5B%22t_df%22%5D%0A%20%20%20%20%20%20%20%20block%20%3D%20cfg%5B%22sampling%22%5D%5B%22block_len%22%5D%0A%0A%20%20%20%20%20%20%20%20infl%20%3D%20cfg%5B%22inflation%22%5D%0A%20%20%20%20%20%20%20%20start_w%20%3D%20cfg%5B%22withdrawals%22%5D%5B%22start_year%22%5D%0A%20%20%20%20%20%20%20%20w_rate%20%3D%20cfg%5B%22withdrawals%22%5D%5B%22rate%22%5D%0A%20%20%20%20%20%20%20%20bridge%20%3D%20cfg%5B%22withdrawals%22%5D%5B%22bridge%22%5D%0A%0A%20%20%20%20%20%20%20%20for%20sim%20in%20range(n_sims)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20pv%20%3D%20initial%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20use_reg%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20reg_mode%20%3D%3D%20%22Fixed%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20regimes%20%3D%20_np.array(%5Bfixed%5D%20*%20months%2C%20dtype%3Dobject)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20regimes%20%3D%20_np.empty(months%2C%20dtype%3Dobject)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20regimes%5B0%5D%20%3D%20%22Normal%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20m%20in%20range(1%2C%20months)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prev%20%3D%20regimes%5Bm%20-%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20prev%20%3D%3D%20%22Bull%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_bull)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bstay%2C%20others%2C%20others%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20prev%20%3D%3D%20%22Normal%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_norm)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bothers%2C%20stay%2C%20others%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_bear)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bothers%2C%20others%2C%20stay%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20regimes%5Bm%5D%20%3D%20_np.random.choice(%5B%22Bull%22%2C%20%22Normal%22%2C%20%22Bear%22%5D%2C%20p%3Dprobs)%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20regimes%20%3D%20_np.array(%5B%22Normal%22%5D%20*%20months%2C%20dtype%3Dobject)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20returns_path%20%3D%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20samp_method%20%3D%3D%20%22Block%20bootstrap%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_len%20%3D%20max(months%2C%20360)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_states%20%3D%20_np.empty(ref_len%2C%20dtype%3Dobject)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_states%5B0%5D%20%3D%20regimes%5B0%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20m%20in%20range(1%2C%20ref_len)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prev%20%3D%20ref_states%5Bm%20-%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20prev%20%3D%3D%20%22Bull%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_bull)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bstay%2C%20others%2C%20others%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20prev%20%3D%3D%20%22Normal%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_norm)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bothers%2C%20stay%2C%20others%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20stay%20%3D%20float(p_bear)%3B%20others%20%3D%20(1.0%20-%20stay)%20%2F%202.0%3B%20probs%20%3D%20%5Bothers%2C%20others%2C%20stay%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_states%5Bm%5D%20%3D%20_np.random.choice(%5B%22Bull%22%2C%20%22Normal%22%2C%20%22Bear%22%5D%2C%20p%3Dprobs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_returns%20%3D%20_np.zeros(ref_len)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20m%20in%20range(ref_len)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20st%20%3D%20ref_states%5Bm%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mu%20%3D%20base_m_mean%20*%20regime_multipliers%5Bst%5D%5B%22mean%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sig%20%3D%20max(1e-12%2C%20base_m_sigma%20*%20regime_multipliers%5Bst%5D%5B%22vol%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20dist_choice%20%3D%3D%20%22Student%20t%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tdf%20%3D%20max(3%2C%20int(dfv))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z%20%3D%20_np.random.standard_t(tdf)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z%20%3D%20z%20*%20_np.sqrt((tdf%20-%202)%20%2F%20tdf)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_returns%5Bm%5D%20%3D%20mu%20%2B%20z%20*%20sig%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ref_returns%5Bm%5D%20%3D%20_np.random.normal(mu%2C%20sig)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b%20%3D%20max(1%2C%20int(block))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chunks%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20need%20%3D%20months%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20while%20need%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20start%20%3D%20_np.random.randint(0%2C%20ref_len)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20end%20%3D%20start%20%2B%20b%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20end%20%3C%3D%20ref_len%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chunk%20%3D%20ref_returns%5Bstart%3Aend%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20wrap%20%3D%20end%20-%20ref_len%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chunk%20%3D%20_np.concatenate(%5Bref_returns%5Bstart%3A%5D%2C%20ref_returns%5B%3Awrap%5D%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20chunks.append(chunk)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20need%20-%3D%20b%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20returns_path%20%3D%20_np.concatenate(chunks)%5B%3Amonths%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20month%20in%20range(1%2C%20months%20%2B%201)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20year%20%3D%20month%20%2F%2F%2012%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20st%20%3D%20regimes%5Bmonth%20-%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20returns_path%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mret%20%3D%20returns_path%5Bmonth%20-%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mu%20%3D%20base_m_mean%20*%20regime_multipliers%5Bst%5D%5B%22mean%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sig%20%3D%20max(1e-12%2C%20base_m_sigma%20*%20regime_multipliers%5Bst%5D%5B%22vol%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20dist_choice%20%3D%3D%20%22Student%20t%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tdf%20%3D%20max(3%2C%20int(dfv))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z%20%3D%20_np.random.standard_t(tdf)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20z%20%3D%20z%20*%20_np.sqrt((tdf%20-%202)%20%2F%20tdf)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mret%20%3D%20mu%20%2B%20z%20*%20sig%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mret%20%3D%20_np.random.normal(mu%2C%20sig)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pv%20*%3D%20(1.0%20%2B%20mret)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20monthly_fee_rate%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pv%20*%3D%20max(0.0%2C%201.0%20-%20monthly_fee_rate)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20in_bridge%20%3D%20bool(bridge%5B%22enable%22%5D)%20and%20(int(bridge%5B%22start%22%5D)%20%3C%3D%20year%20%3C%20int(bridge%5B%22start%22%5D%20%2B%20bridge%5B%22duration%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20in_bridge%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annual_withdrawal_b%20%3D%20max(0.0%2C%20pv)%20*%20float(bridge%5B%22rate%22%5D)%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pv%20%3D%20max(0.0%2C%20pv%20-%20(annual_withdrawal_b%20%2F%2012.0))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20year%20%3C%20int(start_w)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20inflated_contrib%20%3D%20monthly%20*%20((1.0%20%2B%20infl)%20**%20(month%20%2F%2012.0))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pv%20%2B%3D%20max(0.0%2C%20inflated_contrib)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20year%20%3E%3D%20int(start_w)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annual_w%20%3D%20max(0.0%2C%20pv)%20*%20float(w_rate)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pv%20%3D%20max(0.0%2C%20pv%20-%20(annual_w%20%2F%2012.0))%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20results%5Bsim%2C%20month%5D%20%3D%20pv%0A%0A%20%20%20%20%20%20%20%20time_index%20%3D%20_np.arange(0%2C%20months%20%2B%201)%20%2F%2012.0%0A%20%20%20%20%20%20%20%20percentiles%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%225th%22%3A%20_np.percentile(results%2C%205%2C%20axis%3D0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2225th%22%3A%20_np.percentile(results%2C%2025%2C%20axis%3D0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2250th%22%3A%20_np.percentile(results%2C%2050%2C%20axis%3D0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2275th%22%3A%20_np.percentile(results%2C%2075%2C%20axis%3D0)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2295th%22%3A%20_np.percentile(results%2C%2095%2C%20axis%3D0)%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20df_results%20%3D%20_pd.DataFrame(%7B%22Year%22%3A%20time_index%2C%20**percentiles%2C%20%22Mean%22%3A%20_np.mean(results%2C%20axis%3D0)%7D)%0A%20%20%20%20%20%20%20%20sample_size%20%3D%20min(50%2C%20n_sims)%0A%20%20%20%20%20%20%20%20sample_indices%20%3D%20_np.random.choice(n_sims%2C%20sample_size%2C%20replace%3DFalse)%0A%20%20%20%20%20%20%20%20sample_paths%20%3D%20results%5Bsample_indices%2C%20%3A%5D%0A%20%20%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22df_results%22%3A%20df_results%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22sample_paths%22%3A%20sample_paths%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22all_results%22%3A%20results%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22portfolio_return%22%3A%20p_return%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22portfolio_vol%22%3A%20p_vol%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22time_index%22%3A%20time_index%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22initial_value%22%3A%20initial%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22months%22%3A%20months%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20def%20simulate_portfolio(cfg%3A%20dict%2C%20assets%3A%20dict)%3A%0A%20%20%20%20%20%20%20%20%23%20Dump%20to%20json%20once%20in%20this%20cell%20to%20standardize%20keys%20for%20caching%0A%20%20%20%20%20%20%20%20c%20%3D%20_json.dumps(cfg%2C%20sort_keys%3DTrue)%0A%20%20%20%20%20%20%20%20a%20%3D%20_json.dumps(assets%2C%20sort_keys%3DTrue)%0A%20%20%20%20%20%20%20%20return%20simulate_portfolio_cached(c%2C%20a)%0A%20%20%20%20return%20(simulate_portfolio%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Master%20disclaimer%20content%20(rendered%20later%20in%20a%20centralized%20control%20panel)%0A%20%20%20%20disclaimer_md%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20**DISCLAIMER%3A%20FOR%20ILLUSTRATIVE%20PURPOSES%20ONLY**%0A%0A%20%20%20%20%20%20%20%20This%20tool%20provides%20hypothetical%20calculations%20and%20does%20not%20constitute%20investment%20advice.%0A%20%20%20%20%20%20%20%20Using%20this%20tool%20does%20not%20create%20a%20client%20relationship%20with%20Invest%20Vegan%20LLC%20dba%20Ethical%20Capital.%0A%0A%20%20%20%20%20%20%20%20**KEY%20LIMITATIONS%3A**%0A%20%20%20%20%20%20%20%20-%20Projections%20are%20mathematical%20illustrations%2C%20not%20predictions%0A%20%20%20%20%20%20%20%20-%20Results%20depend%20on%20assumptions%20that%20may%20not%20match%20reality%0A%20%20%20%20%20%20%20%20-%20Past%20performance%20does%20not%20guarantee%20future%20results%0A%20%20%20%20%20%20%20%20-%20Cannot%20consider%20your%20complete%20financial%20situation%0A%20%20%20%20%20%20%20%20-%20Not%20personalized%20investment%2C%20tax%2C%20or%20legal%20advice%0A%0A%20%20%20%20%20%20%20%20**INVESTMENT%20RISKS%3A**%0A%20%20%20%20%20%20%20%20All%20investments%20risk%20loss%20of%20principal.%20Actual%20results%20will%20vary%20significantly%20from%20projections.%0A%0A%20%20%20%20%20%20%20%20By%20using%20this%20tool%2C%20you%20accept%20full%20responsibility%20for%20your%20financial%20decisions.%0A%20%20%20%20%20%20%20%20Investment%20advisory%20services%20offered%20only%20through%20formal%20agreements%20with%0A%20%20%20%20%20%20%20%20Invest%20Vegan%20LLC%20dba%20Ethical%20Capital%2C%20a%20registered%20investment%20adviser.%0A%0A%20%20%20%20%20%20%20%20For%20actual%20financial%20planning%2C%20consult%20an%20actual%20financial%20planner.%0A%0A%20%20%20%20%20%20%20%20%C2%A9%202025%20Invest%20Vegan%20LLC%20dba%20Ethical%20Capital%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20).callout(kind%3D%22danger%22)%0A%0A%20%20%20%20accept_disclaimer%20%3D%20mo.ui.switch(%0A%20%20%20%20%20%20%20%20value%3DFalse%2C%0A%20%20%20%20%20%20%20%20label%3D%22I%20understand%20and%20agree%20to%20the%20disclaimer%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Do%20not%20render%20here%3B%20the%20main%20layout%20cell%20will%20place%20this%20appropriately%0A%20%20%20%20return%20accept_disclaimer%2C%20disclaimer_md%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20boxplot_step_years%2C%0A%20%20%20%20go%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A)%3A%0A%20%20%20%20%23%20Per-year%20distribution%20boxplots%20to%20clarify%20spread%20over%20time%0A%20%20%20%20fig_boxes%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20step%20%3D%20max(1%2C%20int(boxplot_step_years.value))%0A%20%20%20%20%20%20%20%20months%20%3D%20simulation_results%5B%22months%22%5D%0A%20%20%20%20%20%20%20%20total_years_box%20%3D%20int(months%20%2F%2F%2012)%0A%20%20%20%20%20%20%20%20years_to_show%20%3D%20list(range(0%2C%20total_years_box%20%2B%201%2C%20step))%0A%20%20%20%20%20%20%20%20if%20years_to_show%5B-1%5D%20!%3D%20total_years_box%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20years_to_show.append(total_years_box)%0A%0A%20%20%20%20%20%20%20%20infl_box%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20fig_boxes%20%3D%20go.Figure()%0A%0A%20%20%20%20%20%20%20%20for%20y%20in%20years_to_show%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20box_month_idx%20%3D%20int(y%20*%2012)%0A%20%20%20%20%20%20%20%20%20%20%20%20vals%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20box_month_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vals%20%3D%20vals%20%2F%20((1.0%20%2B%20infl_box)%20**%20(y))%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_boxes.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Box(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dvals%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3Df%22Year%20%7By%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20boxmean%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20jitter%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pointpos%3D0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker_color%3D%22rgba(100%2C149%2C237%2C0.6)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3D%22rgba(100%2C149%2C237%2C1.0)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20fig_boxes.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Per-Year%20Distribution%20of%20Possible%20Outcomes%20(Boxplots)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Portfolio%20Value%20(%24)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Year%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis%3Ddict(tickformat%3D%22%24%2C.0f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D420%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.ui.plotly(fig_boxes)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(inflation_rate%2C%20mo%2C%20pd%2C%20show_real%2C%20simulation_results)%3A%0A%20%20%20%20%23%20CSV%20export%20options%0A%20%20%20%20df_percentiles%20%3D%20None%0A%20%20%20%20df_finals%20%3D%20None%0A%20%20%20%20df_paths%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20infl_csv%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20time_index_csv%20%3D%20simulation_results%5B%22time_index%22%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Percentiles%20DataFrame%0A%20%20%20%20%20%20%20%20df_percentiles_local%20%3D%20simulation_results%5B%22df_results%22%5D.copy()%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20deflator_csv%20%3D%20(1.0%20%2B%20infl_csv)%20**%20time_index_csv%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20_col%20in%20%5B%225th%22%2C%20%2225th%22%2C%20%2250th%22%2C%20%2275th%22%2C%20%2295th%22%2C%20%22Mean%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_percentiles_local%5B_col%5D%20%3D%20df_percentiles_local%5B_col%5D.values%20%2F%20deflator_csv%0A%20%20%20%20%20%20%20%20df_percentiles%20%3D%20df_percentiles_local%0A%0A%20%20%20%20%20%20%20%20%23%20Final%20values%20DataFrame%0A%20%20%20%20%20%20%20%20finals_csv%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20-1%5D%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20horizon_years_csv%20%3D%20simulation_results%5B%22months%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20%20%20%20%20finals_csv%20%3D%20finals_csv%20%2F%20((1.0%20%2B%20infl_csv)%20**%20horizon_years_csv)%0A%20%20%20%20%20%20%20%20df_finals%20%3D%20pd.DataFrame(%7B%22FinalValue%22%3A%20finals_csv%7D)%0A%0A%20%20%20%20%20%20%20%20%23%20Sample%20paths%20DataFrame%20(limited)%0A%20%20%20%20%20%20%20%20paths_arr%20%3D%20simulation_results%5B%22sample_paths%22%5D%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20deflator_csv%20%3D%20(1.0%20%2B%20infl_csv)%20**%20time_index_csv%0A%20%20%20%20%20%20%20%20%20%20%20%20paths_arr%20%3D%20paths_arr%20%2F%20deflator_csv%0A%20%20%20%20%20%20%20%20data_csv%20%3D%20%7B%22Year%22%3A%20time_index_csv%7D%0A%20%20%20%20%20%20%20%20for%20path_idx%20in%20range(paths_arr.shape%5B0%5D)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20data_csv%5Bf%22Path_%7Bpath_idx%2B1%7D%22%5D%20%3D%20paths_arr%5Bpath_idx%5D%0A%20%20%20%20%20%20%20%20df_paths%20%3D%20pd.DataFrame(data_csv)%0A%0A%20%20%20%20%20%20%20%20%23%20Download%20links%0A%20%20%20%20%20%20%20%20percentiles_csv%20%3D%20df_percentiles.to_csv(index%3DFalse).encode(%22utf-8%22)%0A%20%20%20%20%20%20%20%20finals_csv%20%3D%20df_finals.to_csv(index%3DFalse).encode(%22utf-8%22)%0A%20%20%20%20%20%20%20%20paths_csv%20%3D%20df_paths.to_csv(index%3DFalse).encode(%22utf-8%22)%0A%0A%20%20%20%20%20%20%20%20def%20make_link(data%3A%20bytes%2C%20name%3A%20str)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20b64%20%3D%20_base64.b64encode(data).decode(%22ascii%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22%3Ca%20download%3D%5C%22%7Bname%7D%5C%22%20href%3D%5C%22data%3Atext%2Fcsv%3Bbase64%2C%7Bb64%7D%5C%22%3E%7Bname%7D%3C%2Fa%3E%22%0A%0A%20%20%20%20%20%20%20%20link1%20%3D%20make_link(%0A%20%20%20%20%20%20%20%20%20%20%20%20percentiles_csv%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22percentiles_%7B'real'%20if%20show_real.value%20else%20'nominal'%7D.csv%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20link2%20%3D%20make_link(%0A%20%20%20%20%20%20%20%20%20%20%20%20finals_csv%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22final_values_%7B'real'%20if%20show_real.value%20else%20'nominal'%7D.csv%22%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20link3%20%3D%20make_link(%0A%20%20%20%20%20%20%20%20%20%20%20%20paths_csv%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22sample_paths_%7B'real'%20if%20show_real.value%20else%20'nominal'%7D.csv%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%23%20%E2%AC%87%EF%B8%8F%20Export%20CSV%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%7Bmo.hstack(%5Bmo.md(link1)%2C%20mo.md(link2)%2C%20mo.md(link3)%5D)%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(inflation_rate%2C%20mo%2C%20pd%2C%20show_real%2C%20simulation_results)%3A%0A%20%20%20%20%23%20Export%20all%20(zip)%20as%20a%20single%20link%0A%20%20%20%20zip_link%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20t%20%3D%20simulation_results%5B%22time_index%22%5D%0A%20%20%20%20%20%20%20%20infl%20%3D%20inflation_rate.value%20%2F%20100.0%0A%0A%20%20%20%20%20%20%20%20%23%20Percentiles%0A%20%20%20%20%20%20%20%20dfp%20%3D%20simulation_results%5B%22df_results%22%5D.copy()%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20defl%20%3D%20(1.0%20%2B%20infl)%20**%20t%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20_col%20in%20%5B%225th%22%2C%20%2225th%22%2C%20%2250th%22%2C%20%2275th%22%2C%20%2295th%22%2C%20%22Mean%22%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dfp%5B_col%5D%20%3D%20dfp%5B_col%5D.values%20%2F%20defl%0A%20%20%20%20%20%20%20%20%23%20Finals%0A%20%20%20%20%20%20%20%20finals%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20-1%5D%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20years_h%20%3D%20simulation_results%5B%22months%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20%20%20%20%20finals%20%3D%20finals%20%2F%20((1.0%20%2B%20infl)%20**%20years_h)%0A%20%20%20%20%20%20%20%20dff%20%3D%20pd.DataFrame(%7B%22FinalValue%22%3A%20finals%7D)%0A%20%20%20%20%20%20%20%20%23%20Paths%0A%20%20%20%20%20%20%20%20paths%20%3D%20simulation_results%5B%22sample_paths%22%5D%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20defl%20%3D%20(1.0%20%2B%20infl)%20**%20t%0A%20%20%20%20%20%20%20%20%20%20%20%20paths%20%3D%20paths%20%2F%20defl%0A%20%20%20%20%20%20%20%20data%20%3D%20%7B%22Year%22%3A%20t%7D%0A%20%20%20%20%20%20%20%20for%20_k%20in%20range(paths.shape%5B0%5D)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20data%5Bf%22Path_%7B_k%2B1%7D%22%5D%20%3D%20paths%5B_k%5D%0A%20%20%20%20%20%20%20%20dfpaths%20%3D%20pd.DataFrame(data)%0A%0A%20%20%20%20%20%20%20%20%23%20Build%20zip%20in%20memory%0A%20%20%20%20%20%20%20%20buf%20%3D%20_io.BytesIO()%0A%20%20%20%20%20%20%20%20with%20_zipfile.ZipFile(buf%2C%20mode%3D%22w%22%2C%20compression%3D_zipfile.ZIP_DEFLATED)%20as%20zf%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20zf.writestr(%22percentiles.csv%22%2C%20dfp.to_csv(index%3DFalse))%0A%20%20%20%20%20%20%20%20%20%20%20%20zf.writestr(%22final_values.csv%22%2C%20dff.to_csv(index%3DFalse))%0A%20%20%20%20%20%20%20%20%20%20%20%20zf.writestr(%22sample_paths.csv%22%2C%20dfpaths.to_csv(index%3DFalse))%0A%20%20%20%20%20%20%20%20b%20%3D%20buf.getvalue()%0A%20%20%20%20%20%20%20%20b64%20%3D%20_base64.b64encode(b).decode(%22ascii%22)%0A%20%20%20%20%20%20%20%20name%20%3D%20f%22mc_export_%7B'real'%20if%20show_real.value%20else%20'nominal'%7D.zip%22%0A%20%20%20%20%20%20%20%20zip_link%20%3D%20f%22%3Ca%20download%3D%5C%22%7Bname%7D%5C%22%20href%3D%5C%22data%3Aapplication%2Fzip%3Bbase64%2C%7Bb64%7D%5C%22%3EDownload%20all%20(zip)%3C%2Fa%3E%22%0A%0A%20%20%20%20%20%20%20%20mo.md(f%22%22%22%0A%20%20%20%20%20%20%20%20%7Bmo.md(zip_link)%7D%0A%20%20%20%20%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Portfolio%20configuration%20inputs%0A%20%20%20%20current_value%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20value%3D100000%2C%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D10000000%2C%0A%20%20%20%20%20%20%20%20step%3D1000%2C%0A%20%20%20%20%20%20%20%20label%3D%22Current%20Value%20(%24)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20annual_savings%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20value%3D12000%2C%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D600000%2C%0A%20%20%20%20%20%20%20%20step%3D500%2C%0A%20%20%20%20%20%20%20%20label%3D%22Annual%20Savings%20(%24)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20years_to_simulate%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D1%2C%0A%20%20%20%20%20%20%20%20stop%3D50%2C%0A%20%20%20%20%20%20%20%20value%3D30%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Years%20to%20Simulate%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20return%20annual_savings%2C%20current_value%2C%20years_to_simulate%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Portfolio%20allocation%20by%20risk%20level%20or%20custom%0A%20%20%20%20risk_mode%20%3D%20mo.ui.dropdown(options%3D%5B%22Risk%20level%22%2C%20%22Custom%22%5D%2C%20value%3D%22Risk%20level%22%2C%20label%3D%22Allocation%20mode%22)%0A%20%20%20%20risk_level%20%3D%20mo.ui.radio(options%3D%5B%221%22%2C%222%22%2C%223%22%2C%224%22%2C%225%22%5D%2C%20value%3D%223%22%2C%20label%3D%22Risk%20level%20(1%3Dconservative%2C%205%3Daggressive)%22)%0A%0A%20%20%20%20%23%20Custom%20percentages%20(used%20when%20risk_mode%20%3D%3D%20'Custom')%0A%20%20%20%20custom_growth%20%3D%20mo.ui.number(value%3D40%2C%20start%3D0%2C%20stop%3D100%2C%20step%3D1%2C%20label%3D%22Growth%20(%25)%22)%0A%20%20%20%20custom_diversified%20%3D%20mo.ui.number(value%3D40%2C%20start%3D0%2C%20stop%3D100%2C%20step%3D1%2C%20label%3D%22Diversified%20(%25)%22)%0A%20%20%20%20custom_income%20%3D%20mo.ui.number(value%3D20%2C%20start%3D0%2C%20stop%3D100%2C%20step%3D1%2C%20label%3D%22Income%20(%25)%22)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20custom_diversified%2C%0A%20%20%20%20%20%20%20%20custom_growth%2C%0A%20%20%20%20%20%20%20%20custom_income%2C%0A%20%20%20%20%20%20%20%20risk_level%2C%0A%20%20%20%20%20%20%20%20risk_mode%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20custom_diversified%2C%0A%20%20%20%20custom_growth%2C%0A%20%20%20%20custom_income%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20risk_level%2C%0A%20%20%20%20risk_mode%2C%0A)%3A%0A%20%20%20%20%23%20Compute%20allocations%20from%20risk%20mode%2Flevel%0A%20%20%20%20levels%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%221%22%3A%20%7B%22growth%22%3A%2010%2C%20%22diversified%22%3A%2040%2C%20%22income%22%3A%2050%7D%2C%0A%20%20%20%20%20%20%20%20%222%22%3A%20%7B%22growth%22%3A%2025%2C%20%22diversified%22%3A%2045%2C%20%22income%22%3A%2030%7D%2C%0A%20%20%20%20%20%20%20%20%223%22%3A%20%7B%22growth%22%3A%2040%2C%20%22diversified%22%3A%2040%2C%20%22income%22%3A%2020%7D%2C%0A%20%20%20%20%20%20%20%20%224%22%3A%20%7B%22growth%22%3A%2055%2C%20%22diversified%22%3A%2035%2C%20%22income%22%3A%2010%7D%2C%0A%20%20%20%20%20%20%20%20%225%22%3A%20%7B%22growth%22%3A%2070%2C%20%22diversified%22%3A%2025%2C%20%22income%22%3A%205%7D%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20if%20risk_mode.value%20%3D%3D%20%22Risk%20level%22%3A%0A%20%20%20%20%20%20%20%20sel%20%3D%20levels.get(risk_level.value%2C%20levels%5B%223%22%5D)%0A%20%20%20%20%20%20%20%20growth_pct%20%3D%20sel%5B%22growth%22%5D%0A%20%20%20%20%20%20%20%20diversified_pct%20%3D%20sel%5B%22diversified%22%5D%0A%20%20%20%20%20%20%20%20income_pct%20%3D%20sel%5B%22income%22%5D%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20growth_pct%20%3D%20float(custom_growth.value)%0A%20%20%20%20%20%20%20%20diversified_pct%20%3D%20float(custom_diversified.value)%0A%20%20%20%20%20%20%20%20income_pct%20%3D%20float(custom_income.value)%0A%0A%20%20%20%20total_allocation%20%3D%20growth_pct%20%2B%20diversified_pct%20%2B%20income_pct%0A%20%20%20%20allocation_warning%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20f%22Total%20allocation%3A%20%7Btotal_allocation%7D%25%20%7B'%E2%9A%A0%EF%B8%8F%20Must%20equal%20100%25'%20if%20total_allocation%20!%3D%20100%20else%20'%E2%9C%85'%7D%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22warn%22%20if%20total_allocation%20!%3D%20100%20else%20%22success%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20allocation_warning%2C%0A%20%20%20%20%20%20%20%20diversified_pct%2C%0A%20%20%20%20%20%20%20%20growth_pct%2C%0A%20%20%20%20%20%20%20%20income_pct%2C%0A%20%20%20%20%20%20%20%20total_allocation%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Withdrawal%20configuration%0A%20%20%20%20withdrawal_start_year%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D50%2C%0A%20%20%20%20%20%20%20%20value%3D30%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Years%20until%20withdrawal%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20withdrawal_rate%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D10%2C%0A%20%20%20%20%20%20%20%20value%3D4%2C%0A%20%20%20%20%20%20%20%20step%3D0.25%2C%0A%20%20%20%20%20%20%20%20label%3D%22Annual%20withdrawal%20rate%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Optional%20temporary%20withdrawal%20schedule%20(%22bridge%22)%0A%20%20%20%20bridge_enable%20%3D%20mo.ui.switch(False%2C%20label%3D%22Add%20temporary%20withdrawal%20period%22)%0A%20%20%20%20bridge_start_years%20%3D%20mo.ui.slider(start%3D0%2C%20stop%3D30%2C%20value%3D3%2C%20step%3D1%2C%20label%3D%22Bridge%20starts%20in%20(years)%22%2C%20show_value%3DTrue)%0A%20%20%20%20bridge_duration_years%20%3D%20mo.ui.slider(start%3D1%2C%20stop%3D10%2C%20value%3D2%2C%20step%3D1%2C%20label%3D%22Bridge%20duration%20(years)%22%2C%20show_value%3DTrue)%0A%20%20%20%20bridge_rate%20%3D%20mo.ui.slider(start%3D0.0%2C%20stop%3D15.0%2C%20value%3D4.0%2C%20step%3D0.25%2C%20label%3D%22Bridge%20withdrawal%20rate%20(%25)%22%2C%20show_value%3DTrue)%0A%0A%20%20%20%20inflation_rate%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3D6%2C%0A%20%20%20%20%20%20%20%20value%3D2.5%2C%0A%20%20%20%20%20%20%20%20step%3D0.25%2C%0A%20%20%20%20%20%20%20%20label%3D%22Assumed%20Inflation%20Rate%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Layout%20is%20handled%20in%20a%20centralized%20control%20panel%3B%20don't%20render%20here.%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20bridge_duration_years%2C%0A%20%20%20%20%20%20%20%20bridge_enable%2C%0A%20%20%20%20%20%20%20%20bridge_rate%2C%0A%20%20%20%20%20%20%20%20bridge_start_years%2C%0A%20%20%20%20%20%20%20%20inflation_rate%2C%0A%20%20%20%20%20%20%20%20withdrawal_rate%2C%0A%20%20%20%20%20%20%20%20withdrawal_start_year%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Monte%20Carlo%20parameters%20%2B%20distribution%20choices%0A%20%20%20%20num_simulations%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D10%2C%0A%20%20%20%20%20%20%20%20stop%3D5000%2C%0A%20%20%20%20%20%20%20%20value%3D500%2C%0A%20%20%20%20%20%20%20%20step%3D10%2C%0A%20%20%20%20%20%20%20%20label%3D%22Number%20of%20Simulations%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%0A%20%20%20%20random_seed%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20value%3D42%2C%0A%20%20%20%20%20%20%20%20start%3D1%2C%0A%20%20%20%20%20%20%20%20stop%3D2**31%20-%201%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Random%20Seed%20(for%20reproducibility)%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20return_dist%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3D%5B%22Student%20t%22%2C%20%22Normal%22%5D%2C%0A%20%20%20%20%20%20%20%20value%3D%22Student%20t%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Return%20distribution%20(assumed)%22%2C%0A%20%20%20%20)%0A%20%20%20%20t_df%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D3%2C%0A%20%20%20%20%20%20%20%20stop%3D30%2C%0A%20%20%20%20%20%20%20%20value%3D6%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22Student%20t%20degrees%20of%20freedom%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20return%20num_simulations%2C%20random_seed%2C%20return_dist%2C%20t_df%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Regime%20model%20and%20sampling%20method%0A%20%20%20%20use_regime%20%3D%20mo.ui.switch(False%2C%20label%3D%22Enable%20regime%20model%22)%0A%20%20%20%20regime_mode%20%3D%20mo.ui.dropdown(options%3D%5B%22Fixed%22%2C%20%22Dynamic%22%5D%2C%20value%3D%22Fixed%22%2C%20label%3D%22Regime%20mode%22)%0A%20%20%20%20fixed_regime%20%3D%20mo.ui.radio(options%3D%5B%22Normal%22%2C%20%22Bull%22%2C%20%22Bear%22%5D%2C%20value%3D%22Normal%22%2C%20label%3D%22Fixed%20regime%22)%0A%0A%20%20%20%20%23%20Persistence%20sliders%20for%20dynamic%20Markov%20regime%20switching%0A%20%20%20%20p_stay_bull%20%3D%20mo.ui.slider(start%3D0.5%2C%20stop%3D0.99%2C%20value%3D0.9%2C%20step%3D0.01%2C%20label%3D%22P(stay%20Bull)%22%2C%20show_value%3DTrue)%0A%20%20%20%20p_stay_normal%20%3D%20mo.ui.slider(start%3D0.5%2C%20stop%3D0.99%2C%20value%3D0.9%2C%20step%3D0.01%2C%20label%3D%22P(stay%20Normal)%22%2C%20show_value%3DTrue)%0A%20%20%20%20p_stay_bear%20%3D%20mo.ui.slider(start%3D0.5%2C%20stop%3D0.99%2C%20value%3D0.9%2C%20step%3D0.01%2C%20label%3D%22P(stay%20Bear)%22%2C%20show_value%3DTrue)%0A%0A%20%20%20%20%23%20Sampling%20method%20and%20block%20bootstrap%20settings%0A%20%20%20%20sampling_method%20%3D%20mo.ui.dropdown(options%3D%5B%22Parametric%22%2C%20%22Block%20bootstrap%22%5D%2C%20value%3D%22Parametric%22%2C%20label%3D%22Return%20sampling%20method%22)%0A%20%20%20%20block_len%20%3D%20mo.ui.slider(start%3D3%2C%20stop%3D12%2C%20value%3D3%2C%20step%3D1%2C%20label%3D%22Block%20length%20(months)%22%2C%20show_value%3DTrue)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20block_len%2C%0A%20%20%20%20%20%20%20%20fixed_regime%2C%0A%20%20%20%20%20%20%20%20p_stay_bear%2C%0A%20%20%20%20%20%20%20%20p_stay_bull%2C%0A%20%20%20%20%20%20%20%20p_stay_normal%2C%0A%20%20%20%20%20%20%20%20regime_mode%2C%0A%20%20%20%20%20%20%20%20sampling_method%2C%0A%20%20%20%20%20%20%20%20use_regime%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(pd)%3A%0A%20%20%20%20%23%20Asset%20class%20parameters%20(historical%20approximations)%0A%20%20%20%20%23%20Asset%20Class%20Parameters%20(rendered%20optionally%20in%20advanced%20section)%0A%0A%20%20%20%20%23%20Return%20and%20volatility%20parameters%0A%20%20%20%20asset_params%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%23%20Based%20on%20provided%20historical%20characteristics%20(see%20appendix%20markdown%20below)%0A%20%20%20%20%20%20%20%20%22growth%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22mean_return%22%3A%200.12%2C%20%20%23%2012%25%20average%20annual%20return%0A%20%20%20%20%20%20%20%20%20%20%20%20%22volatility%22%3A%200.25%2C%20%20%23%2025%25%20standard%20deviation%0A%20%20%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20%2225-Stock%20Concentrated%20Equity%22%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22diversified%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22mean_return%22%3A%200.09%2C%20%20%23%209%25%20average%20annual%20return%20(GTAA)%0A%20%20%20%20%20%20%20%20%20%20%20%20%22volatility%22%3A%200.10%2C%20%20%23%2010%25%20standard%20deviation%0A%20%20%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20%22Global%20Tactical%20Asset%20Allocation%22%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%22income%22%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22mean_return%22%3A%200.06%2C%20%20%23%206%25%20average%20annual%20return%0A%20%20%20%20%20%20%20%20%20%20%20%20%22volatility%22%3A%200.06%2C%20%20%23%206%25%20standard%20deviation%0A%20%20%20%20%20%20%20%20%20%20%20%20%22name%22%3A%20%22Income%20(Bond-Heavy%20Portfolio)%22%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20%23%20Create%20a%20nice%20display%20table%0A%20%20%20%20params_df%20%3D%20pd.DataFrame(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Asset%20Class%22%3A%20params%5B%22name%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Illustrative%20Return%22%3A%20f%22%7Bparams%5B'mean_return'%5D*100%3A.1f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Volatility%22%3A%20f%22%7Bparams%5B'volatility'%5D*100%3A.1f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20params%20in%20asset_params.values()%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20return%20asset_params%2C%20params_df%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Fees%20%26%20Costs%20(no%20commissions%20modeled)%0A%20%20%20%20base_fee_all%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0.0%2C%0A%20%20%20%20%20%20%20%20stop%3D3.0%2C%0A%20%20%20%20%20%20%20%20value%3D1.0%2C%0A%20%20%20%20%20%20%20%20step%3D0.05%2C%0A%20%20%20%20%20%20%20%20label%3D%22Annual%20Fee%20%E2%80%93%20All%20Strategies%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20sub_fee_diversified%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0.0%2C%0A%20%20%20%20%20%20%20%20stop%3D3.0%2C%0A%20%20%20%20%20%20%20%20value%3D0.5%2C%0A%20%20%20%20%20%20%20%20step%3D0.05%2C%0A%20%20%20%20%20%20%20%20label%3D%22Sub-Manager%20Fee%20%E2%80%93%20Diversified%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20sub_fee_income%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0.0%2C%0A%20%20%20%20%20%20%20%20stop%3D3.0%2C%0A%20%20%20%20%20%20%20%20value%3D0.5%2C%0A%20%20%20%20%20%20%20%20step%3D0.05%2C%0A%20%20%20%20%20%20%20%20label%3D%22Sub-Manager%20Fee%20%E2%80%93%20Income%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20show_value%3DTrue%2C%0A%20%20%20%20)%0A%20%20%20%20return%20base_fee_all%2C%20sub_fee_diversified%2C%20sub_fee_income%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Mode%20%2B%20Run%20%2B%20Reset%0A%20%20%20%20english_mode%20%3D%20mo.ui.switch(value%3DTrue%2C%20label%3D%22English%20(simple)%22)%0A%20%20%20%20run_button%20%3D%20mo.ui.button(label%3D%22Run%20simulation%22)%0A%20%20%20%20reset_button%20%3D%20mo.ui.button(label%3D%22Reset%22)%0A%20%20%20%20%23%20Export%20in%20the%20same%20order%20as%20created%20to%20avoid%20mis-binding%0A%20%20%20%20return%20english_mode%2C%20reset_button%2C%20run_button%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Assumptions%20strip%20for%20English%20mode%20(rendered%20later)%0A%20%20%20%20assumptions%20%3D%20mo.callout(%0A%20%20%20%20%20%20%20%20%22Using%20illustrative%20defaults%3A%20Student%20t%20(df%3D6)%2C%20parametric%20sampling%2C%20no%20regimes%2C%20base%20fee%201.0%25%20%2B%20sub-fees%2C%20monthly%20fees%20applied%20as%20AUM%20drag.%22%2C%0A%20%20%20%20%20%20%20%20kind%3D%22info%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(assumptions%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20%23%20Visualization%20settings%20and%20targets%20(advanced%3B%20rendered%20in%20control%20panel)%0A%20%20%20%20show_real%20%3D%20mo.ui.switch(value%3DFalse%2C%20label%3D%22Show%20real%20(inflation-adjusted)%20values%22)%0A%20%20%20%20log_scale%20%3D%20mo.ui.switch(value%3DFalse%2C%20label%3D%22Log%20scale%20(Y%20axis)%22)%0A%20%20%20%20show_band_95%20%3D%20mo.ui.switch(value%3DTrue%2C%20label%3D%22Show%205%E2%80%9395%25%20band%22)%0A%20%20%20%20show_band_75%20%3D%20mo.ui.switch(value%3DTrue%2C%20label%3D%22Show%2025%E2%80%9375%25%20band%22)%0A%20%20%20%20path_style%20%3D%20mo.ui.dropdown(options%3D%5B%22Sample%22%2C%20%22All%20(WebGL)%22%2C%20%22None%22%5D%2C%20value%3D%22Sample%22%2C%20label%3D%22Path%20overlay%22)%0A%20%20%20%20paths_max%20%3D%20mo.ui.slider(start%3D0%2C%20stop%3D1000%2C%20value%3D200%2C%20step%3D10%2C%20label%3D%22Max%20paths%20to%20draw%22%2C%20show_value%3DTrue)%0A%20%20%20%20boxplot_step_years%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D1%2C%20stop%3D10%2C%20value%3D5%2C%20step%3D1%2C%20label%3D%22Boxplot%3A%20year%20step%22%2C%20show_value%3DTrue%0A%20%20%20%20)%0A%20%20%20%20target_final_value%20%3D%20mo.ui.number(%0A%20%20%20%20%20%20%20%20value%3D1_000_000%2C%20start%3D0%2C%20stop%3D100_000_000%2C%20step%3D50_000%2C%20label%3D%22Target%20final%20value%20(%24)%22%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20boxplot_step_years%2C%0A%20%20%20%20%20%20%20%20log_scale%2C%0A%20%20%20%20%20%20%20%20path_style%2C%0A%20%20%20%20%20%20%20%20paths_max%2C%0A%20%20%20%20%20%20%20%20show_band_75%2C%0A%20%20%20%20%20%20%20%20show_band_95%2C%0A%20%20%20%20%20%20%20%20show_real%2C%0A%20%20%20%20%20%20%20%20target_final_value%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20scenario%20%3D%20mo.ui.radio(%0A%20%20%20%20%20%20%20%20options%3D%5B%22Conservative%20(25th)%22%2C%20%22Median%20(50th)%22%2C%20%22Optimistic%20(75th)%22%5D%2C%0A%20%20%20%20%20%20%20%20value%3D%22Median%20(50th)%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Scenario%20highlight%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(scenario%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20accept_disclaimer%2C%0A%20%20%20%20allocation_warning%2C%0A%20%20%20%20annual_savings%2C%0A%20%20%20%20assumptions%2C%0A%20%20%20%20base_fee_all%2C%0A%20%20%20%20block_len%2C%0A%20%20%20%20boxplot_step_years%2C%0A%20%20%20%20bridge_duration_years%2C%0A%20%20%20%20bridge_enable%2C%0A%20%20%20%20bridge_rate%2C%0A%20%20%20%20bridge_start_years%2C%0A%20%20%20%20current_value%2C%0A%20%20%20%20custom_diversified%2C%0A%20%20%20%20custom_growth%2C%0A%20%20%20%20custom_income%2C%0A%20%20%20%20disclaimer_md%2C%0A%20%20%20%20english_mode%2C%0A%20%20%20%20fixed_regime%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20log_scale%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20num_simulations%2C%0A%20%20%20%20p_stay_bear%2C%0A%20%20%20%20p_stay_bull%2C%0A%20%20%20%20p_stay_normal%2C%0A%20%20%20%20params_df%2C%0A%20%20%20%20path_style%2C%0A%20%20%20%20paths_max%2C%0A%20%20%20%20random_seed%2C%0A%20%20%20%20regime_mode%2C%0A%20%20%20%20reset_button%2C%0A%20%20%20%20return_dist%2C%0A%20%20%20%20risk_level%2C%0A%20%20%20%20risk_mode%2C%0A%20%20%20%20run_button%2C%0A%20%20%20%20sampling_method%2C%0A%20%20%20%20scenario%2C%0A%20%20%20%20show_band_75%2C%0A%20%20%20%20show_band_95%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20sub_fee_diversified%2C%0A%20%20%20%20sub_fee_income%2C%0A%20%20%20%20t_df%2C%0A%20%20%20%20target_final_value%2C%0A%20%20%20%20total_allocation%2C%0A%20%20%20%20use_regime%2C%0A%20%20%20%20withdrawal_rate%2C%0A%20%20%20%20withdrawal_start_year%2C%0A%20%20%20%20years_to_simulate%2C%0A)%3A%0A%20%20%20%20%23%20Top%20control%20panel%3A%20essential%20inputs%20only%0A%20%20%20%20_header%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20%22%23%23%20%F0%9F%9A%80%20Get%20Started%5CnFill%20the%20required%20fields%2C%20read%20the%20disclaimer%2C%20accept%20it%2C%20then%20press%20Run.%22%0A%20%20%20%20)%0A%20%20%20%20_req_rows%20%3D%20%5B%0A%20%20%20%20%20%20%20%20mo.hstack(%5Benglish_mode%5D)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bcurrent_value%2C%20annual_savings%2C%20years_to_simulate%5D)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Brisk_mode%2C%20risk_level%5D)%2C%0A%20%20%20%20%5D%0A%20%20%20%20%23%20If%20Custom%20is%20chosen%2C%20surface%20the%20custom%20sliders%20inline%20%2B%20warning%0A%20%20%20%20if%20getattr(risk_mode%2C%20%22value%22%2C%20%22Risk%20level%22)%20%3D%3D%20%22Custom%22%3A%0A%20%20%20%20%20%20%20%20_req_rows.append(mo.hstack(%5Bcustom_growth%2C%20custom_diversified%2C%20custom_income%5D))%0A%20%20%20%20%20%20%20%20_req_rows.append(allocation_warning)%0A%20%20%20%20_req_rows.append(mo.hstack(%5Bwithdrawal_start_year%2C%20scenario%5D))%0A%20%20%20%20_required%20%3D%20mo.vstack(_req_rows)%0A%20%20%20%20_assump%20%3D%20assumptions%20if%20english_mode.value%20else%20None%0A%0A%20%20%20%20%23%20Quick%20status%20helper%0A%20%20%20%20_ready_msgs%20%3D%20%5B%5D%0A%20%20%20%20if%20total_allocation%20!%3D%20100%3A%0A%20%20%20%20%20%20%20%20_ready_msgs.append(%22Allocations%20must%20sum%20to%20100%25.%22)%0A%20%20%20%20if%20not%20accept_disclaimer.value%3A%0A%20%20%20%20%20%20%20%20_ready_msgs.append(%22Please%20accept%20the%20disclaimer.%22)%0A%20%20%20%20_ready_callout%20%3D%20mo.callout(%22%5Cn%22.join(_ready_msgs)%2C%20kind%3D%22warn%22)%20if%20_ready_msgs%20else%20mo.callout(%22Ready%20to%20run.%22%2C%20kind%3D%22success%22)%0A%0A%20%20%20%20_disclaimer_block%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20%E2%9A%A0%EF%B8%8F%20Disclaimer%22)%2C%0A%20%20%20%20%20%20%20%20disclaimer_md%2C%0A%20%20%20%20%20%20%20%20accept_disclaimer%2C%0A%20%20%20%20%20%20%20%20_ready_callout%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Brun_button%2C%20reset_button%5D)%2C%0A%20%20%20%20%20%20%20%20mo.md(f%22Run%20clicks%3A%20%7Bint(getattr(run_button%2C%20'value'%2C%200)%20or%200)%7D%20%7C%20Reset%20clicks%3A%20%7Bint(getattr(reset_button%2C%20'value'%2C%200)%20or%200)%7D%22)%2C%0A%20%20%20%20%20%20%20%20mo.md(%22Note%3A%20In%20static%20HTML%20exports%20(non%E2%80%91WASM)%20the%20Run%20button%20cannot%20recompute%3B%20use%20the%20live%20app%20(%60marimo%20run%20...%60)%20or%20export%20with%20%60marimo%20export%20html-wasm%60%20for%20offline%20interactivity.%22)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20%23%20Advanced%20options%20in%20an%20accordion%0A%20%20%20%20_section_alloc%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22Customize%20(only%20used%20if%20'Custom'%20selected)%3A%22)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bcustom_growth%2C%20custom_diversified%2C%20custom_income%5D)%2C%0A%20%20%20%20%20%20%20%20allocation_warning%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20_section_withdraw%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bwithdrawal_rate%2C%20inflation_rate%5D)%2C%0A%20%20%20%20%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20bridge_enable%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bbridge_start_years%2C%20bridge_duration_years%2C%20bridge_rate%5D)%2C%0A%20%20%20%20%20%20%20%20%5D)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20_section_mc%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bnum_simulations%2C%20random_seed%2C%20return_dist%2C%20t_df%5D)%2C%0A%20%20%20%20%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Buse_regime%2C%20regime_mode%2C%20fixed_regime%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bp_stay_bull%2C%20p_stay_normal%2C%20p_stay_bear%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%5Bsampling_method%2C%20block_len%5D)%2C%0A%20%20%20%20%20%20%20%20%5D)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20_section_fees%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22Assumes%20no%20commissions.%20Fees%20applied%20monthly%20as%20AUM%20%25.%22)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bbase_fee_all%2C%20sub_fee_diversified%2C%20sub_fee_income%5D)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20_section_view%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bshow_real%2C%20log_scale%5D)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bshow_band_95%2C%20show_band_75%2C%20path_style%2C%20paths_max%5D)%2C%0A%20%20%20%20%20%20%20%20mo.hstack(%5Bboxplot_step_years%2C%20target_final_value%5D)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20_section_params%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22Illustrative%20asset%20class%20parameters%22)%2C%0A%20%20%20%20%20%20%20%20mo.ui.table(data%3Dparams_df)%2C%0A%20%20%20%20%5D)%0A%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20_advanced%20%3D%20mo.accordion(%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Customize%20Allocation%22%3A%20_section_alloc%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Withdrawals%20(Advanced)%22%3A%20_section_withdraw%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Monte%20Carlo%20%26%20Sampling%22%3A%20_section_mc%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Fees%20%26%20Costs%22%3A%20_section_fees%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22View%20%26%20Targets%22%3A%20_section_view%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Data%20%26%20Parameters%22%3A%20_section_params%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%23%20Fallback%20if%20accordion%20is%20unavailable%0A%20%20%20%20%20%20%20%20_advanced%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Advanced%20Options%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_alloc%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_withdraw%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_mc%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_fees%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_view%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20_section_params%2C%0A%20%20%20%20%20%20%20%20%5D)%0A%20%20%20%20panel_ui%20%3D%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20_header%2C%0A%20%20%20%20%20%20%20%20_required%2C%0A%20%20%20%20%20%20%20%20_assump%20if%20_assump%20is%20not%20None%20else%20mo.md(%22%22)%2C%0A%20%20%20%20%20%20%20%20_disclaimer_block%2C%0A%20%20%20%20%20%20%20%20_advanced%2C%0A%20%20%20%20%5D)%0A%20%20%20%20panel_ui%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20accept_disclaimer%2C%0A%20%20%20%20err%2C%0A%20%20%20%20error_msg%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20reset_button%2C%0A%20%20%20%20run_button%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20total_allocation%2C%0A)%3A%0A%20%20%20%20%23%20Status%20panel%20just%20below%20controls%2C%20using%20marimo.status%20when%20available%0A%20%20%20%20def%20_status(kind%3A%20str%2C%20text%3A%20str)%3A%0A%20%20%20%20%20%20%20%20st%20%3D%20getattr(mo%2C%20%22status%22%2C%20None)%0A%20%20%20%20%20%20%20%20if%20st%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fn%20%3D%20getattr(st%2C%20kind%2C%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20callable(fn)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20fn(text)%0A%20%20%20%20%20%20%20%20%23%20Fallback%20to%20callouts%0A%20%20%20%20%20%20%20%20kind_map%20%3D%20%7B%22success%22%3A%20%22success%22%2C%20%22error%22%3A%20%22danger%22%2C%20%22warning%22%3A%20%22warn%22%2C%20%22info%22%3A%20%22info%22%7D%0A%20%20%20%20%20%20%20%20return%20mo.callout(text%2C%20kind%3Dkind_map.get(kind%2C%20%22info%22))%0A%0A%20%20%20%20clicks%20%3D%20int(getattr(run_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20resets%20%3D%20int(getattr(reset_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20can_run%20%3D%20bool(accept_disclaimer.value)%20and%20(total_allocation%20%3D%3D%20100)%0A%20%20%20%20running%20%3D%20(clicks%20%3E%20resets)%20and%20can_run%20and%20(not%20simulation_results)%20and%20(not%20error_msg)%0A%0A%20%20%20%20%23%20Include%20config%20validation%20error%20if%20present%0A%20%20%20%20_cfg_err%20%3D%20err%0A%0A%20%20%20%20if%20not%20accept_disclaimer.value%3A%0A%20%20%20%20%20%20%20%20_status(%22info%22%2C%20%22Please%20accept%20the%20disclaimer%20to%20enable%20Run.%22)%0A%20%20%20%20elif%20total_allocation%20!%3D%20100%3A%0A%20%20%20%20%20%20%20%20_status(%22warning%22%2C%20%22Allocations%20must%20sum%20to%20100%25.%22)%0A%20%20%20%20elif%20_cfg_err%3A%0A%20%20%20%20%20%20%20%20_status(%22warning%22%2C%20_cfg_err)%0A%20%20%20%20elif%20running%3A%0A%20%20%20%20%20%20%20%20_status(%22spinner%22%2C%20%22Running%20simulation...%22)%0A%20%20%20%20elif%20error_msg%3A%0A%20%20%20%20%20%20%20%20_status(%22error%22%2C%20error_msg)%0A%20%20%20%20elif%20simulation_results%3A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_status(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22success%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Done%3A%20%7Bsimulation_results%5B'all_results'%5D.shape%5B0%5D%7D%20runs%2C%20%7Bsimulation_results%5B'months'%5D%2F12%3A.1f%7D%20years.%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_status(%22success%22%2C%20%22Done.%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20_status(%22info%22%2C%20%22Press%20Run%20to%20compute.%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(accept_disclaimer%2C%20mo%2C%20reset_button%2C%20run_button%2C%20total_allocation)%3A%0A%20%20%20%20%23%20Stable%20run%20token%3A%20increments%20only%20when%20a%20legitimate%20Run%20occurs%0A%20%20%20%20token%20%3D%20mo.state(0)%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20rc%20%3D%20int(getattr(run_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20%20%20%20%20rz%20%3D%20int(getattr(reset_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20%20%20%20%20if%20accept_disclaimer.value%20and%20total_allocation%20%3D%3D%20100%20and%20rc%20%3E%20rz%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Use%20rc%20to%20avoid%20repeated%20sets%20for%20the%20same%20click%20count%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20token.value%20!%3D%20rc%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20token.set(rc)%0A%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20pass%0A%20%20%20%20return%20(token%2C)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20accept_disclaimer%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20reset_button%2C%0A%20%20%20%20run_button%2C%0A%20%20%20%20token%2C%0A%20%20%20%20total_allocation%2C%0A)%3A%0A%20%20%20%20%23%20Debug%20strip%3A%20make%20gating%20state%20explicit%20under%20the%20status%20panel%0A%20%20%20%20_rc%20%3D%20int(getattr(run_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20_rz%20%3D%20int(getattr(reset_button%2C%20%22value%22%2C%200)%20or%200)%0A%20%20%20%20_ready%20%3D%20bool(accept_disclaimer.value)%20and%20(total_allocation%20%3D%3D%20100)%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20f%22Ready%3A%20%7B_ready%7D%20%7C%20Run%20clicks%3A%20%7B_rc%7D%20%7C%20Reset%20clicks%3A%20%7B_rz%7D%20%7C%20Token%3A%20%7Bint(getattr(token%2C'value'%2C0)%20or%200)%7D%22%0A%20%20%20%20).callout(kind%3D%22info%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20accept_disclaimer%2C%0A%20%20%20%20assets%2C%0A%20%20%20%20cfg%2C%0A%20%20%20%20simulate_portfolio%2C%0A%20%20%20%20token%2C%0A%20%20%20%20total_allocation%2C%0A)%3A%0A%20%20%20%20%23%20New%20gating%20via%20stable%20run%20token%3B%20ignore%20direct%20button%20values%20here%0A%20%20%20%20error_msg%20%3D%20None%0A%20%20%20%20simulation_results%20%3D%20None%0A%20%20%20%20if%20not%20accept_disclaimer.value%20or%20total_allocation%20!%3D%20100%3A%0A%20%20%20%20%20%20%20%20%23%20Not%20ready%20or%20not%20requested%3A%20publish%20names%20as%20None%0A%20%20%20%20%20%20%20%20pass%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20token%20value%20change%20indicates%20a%20new%20run%20request%0A%20%20%20%20%20%20%20%20%20%20%20%20_%20%3D%20token.value%20%20%23%20depend%20on%20token%20only%3B%20value%20unused%20otherwise%0A%20%20%20%20%20%20%20%20%20%20%20%20simulation_results%20%3D%20simulate_portfolio(cfg%2C%20assets)%0A%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20error_msg%20%3D%20f%22Simulation%20error%3A%20%7Be%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20simulation_results%20%3D%20None%0A%20%20%20%20return%20error_msg%2C%20simulation_results%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20brand%2C%0A%20%20%20%20english_mode%2C%0A%20%20%20%20error_msg%2C%0A%20%20%20%20go%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20log_scale%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20path_style%2C%0A%20%20%20%20paths_max%2C%0A%20%20%20%20scenario%2C%0A%20%20%20%20show_band_75%2C%0A%20%20%20%20show_band_95%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20withdrawal_start_year%2C%0A)%3A%0A%20%20%20%20fig%20%3D%20None%0A%20%20%20%20if%20error_msg%3A%0A%20%20%20%20%20%20%20%20mo.callout(f%22Error%3A%20%7Berror_msg%7D%22%2C%20kind%3D%22danger%22)%0A%20%20%20%20elif%20simulation_results%3A%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%20Results%22)%0A%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Ran%20%7Bsimulation_results%5B'all_results'%5D.shape%5B0%5D%7D%20simulations%20for%20%7Bsimulation_results%5B'months'%5D%2F12%3A.1f%7D%20years.%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22success%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20pass%0A%20%20%20%20%20%20%20%20%23%20Create%20main%20visualization%20(fan%20chart)%0A%20%20%20%20%20%20%20%20fig%20%3D%20go.Figure()%0A%0A%20%20%20%20%20%20%20%20%23%20Prepare%20data%20(real%20vs%20nominal)%0A%20%20%20%20%20%20%20%20time_index_plot%20%3D%20simulation_results%5B%22time_index%22%5D%0A%20%20%20%20%20%20%20%20infl_plot%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20deflator_plot%20%3D%20(1.0%20%2B%20infl_plot)%20**%20time_index_plot%0A%0A%20%20%20%20%20%20%20%20def%20adj(arr)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20arr%20%2F%20deflator_plot%20if%20show_real.value%20else%20arr%0A%0A%20%20%20%20%20%20%20%20df_plot%20%3D%20simulation_results%5B%22df_results%22%5D%0A%20%20%20%20%20%20%20%20p5_line%20%3D%20adj(df_plot%5B%225th%22%5D.values)%0A%20%20%20%20%20%20%20%20p25_line%20%3D%20adj(df_plot%5B%2225th%22%5D.values)%0A%20%20%20%20%20%20%20%20p50_line%20%3D%20adj(df_plot%5B%2250th%22%5D.values)%0A%20%20%20%20%20%20%20%20p75_line%20%3D%20adj(df_plot%5B%2275th%22%5D.values)%0A%20%20%20%20%20%20%20%20p95_line%20%3D%20adj(df_plot%5B%2295th%22%5D.values)%0A%0A%20%20%20%20%20%20%20%20%23%20Brand-aware%20colors%20(fallbacks%20are%20already%20set%20in%20brand%20cell)%0A%20%20%20%20%20%20%20%20color_blue%20%3D%20brand.get(%22primary%22%2C%20%22%230072B2%22)%0A%20%20%20%20%20%20%20%20color_orange%20%3D%20brand.get(%22accent%22%2C%20%22%23E69F00%22)%0A%20%20%20%20%20%20%20%20color_gray%20%3D%20brand.get(%22muted%22%2C%20%22%23999999%22)%0A%20%20%20%20%20%20%20%20color_lightgray%20%3D%20brand.get(%22band_fill_outer%22%2C%20%22rgba(160%2C160%2C160%2C0.35)%22)%0A%0A%20%20%20%20%20%20%20%20%23%2095%25%20band%20(area%20between%20p5%20and%20p95)%20%E2%80%94%20hide%20in%20English%20mode%0A%20%20%20%20%20%20%20%20if%20show_band_95.value%20and%20not%20english_mode.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp95_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3D%22rgba(34%2C139%2C34%2C0.0)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22skip%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp5_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill%3D%22tonexty%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fillcolor%3Dcolor_lightgray%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3D%22rgba(34%2C139%2C34%2C0.0)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%225%E2%80%9395%25%20band%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%2025%E2%80%9375%25%20band%20(inner%20area)%20%E2%80%94%20always%20show%2C%20but%20use%20gray%20palette%0A%20%20%20%20%20%20%20%20if%20show_band_75.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp75_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3D%22rgba(0%2C0%2C0%2C0.0)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22skip%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp25_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill%3D%22tonexty%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fillcolor%3D%22rgba(120%2C120%2C120%2C0.35)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3D%22rgba(0%2C0%2C0%2C0.0)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2225%E2%80%9375%25%20band%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Median%20and%20mean%20lines%20%E2%80%94%20executive%20friendly%20colors%0A%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp50_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_blue%2C%20width%3D2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22Median%20(50th)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%23%20Mean%20line%0A%20%20%20%20%20%20%20%20mean_vals%20%3D%20adj(df_plot%5B%22Mean%22%5D.values)%0A%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dmean_vals%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_orange%2C%20width%3D1.5%2C%20dash%3D%22dot%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22Mean%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Scenario%20highlight%0A%20%20%20%20%20%20%20%20scen%20%3D%20scenario.value%0A%20%20%20%20%20%20%20%20scen_line%20%3D%20None%0A%20%20%20%20%20%20%20%20scen_name%20%3D%20None%0A%20%20%20%20%20%20%20%20if%20scen.startswith(%22Conservative%22)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20scen_line%2C%20scen_name%20%3D%20p25_line%2C%20%2225th%20Percentile%22%0A%20%20%20%20%20%20%20%20elif%20scen.startswith(%22Median%22)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20scen_line%2C%20scen_name%20%3D%20p50_line%2C%20%22Median%20(50th)%22%0A%20%20%20%20%20%20%20%20elif%20scen.startswith(%22Optimistic%22)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20scen_line%2C%20scen_name%20%3D%20p75_line%2C%20%2275th%20Percentile%22%0A%20%20%20%20%20%20%20%20if%20scen_line%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dscen_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_orange%2C%20width%3D3)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3Df%22Scenario%3A%20%7Bscen_name%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Percentile%20edge%20lines%20%E2%80%94%20in%20English%20mode%2C%20show%20only%2025%2F75%20around%20the%20median%0A%20%20%20%20%20%20%20%20if%20english_mode.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp75_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2275th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp25_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2225th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp95_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1%2C%20dash%3D%22dash%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2295th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp75_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2275th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp25_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%2225th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dp5_line%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dcolor_gray%2C%20width%3D1%2C%20dash%3D%22dash%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%225th%20Percentile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Year%3A%20%25%7Bx%3A.1f%7D%3Cbr%3EValue%3A%20%24%25%7By%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20path%20overlays%20(grey)%20per%20selection%0A%20%20%20%20%20%20%20%20if%20path_style.value%20!%3D%20%22None%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20all_paths%20%3D%20simulation_results%5B%22all_results%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20num_paths_draw%20%3D%20int(paths_max.value)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20num_paths_draw%20%3E%200%20and%20all_paths.shape%5B0%5D%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20num_paths_draw%20%3D%20min(num_paths_draw%2C%20all_paths.shape%5B0%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20pick%20evenly%20spaced%20paths%20for%20representative%20coverage%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20path_sel_idx%20%3D%20np.linspace(0%2C%20all_paths.shape%5B0%5D%20-%201%2C%20num%3Dnum_paths_draw%2C%20dtype%3Dint)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20overlay_paths%20%3D%20all_paths%5Bpath_sel_idx%2C%20%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20overlay_paths%20%3D%20overlay_paths%20%2F%20deflator_plot%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20path_style.value%20%3D%3D%20%22Sample%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Draw%20each%20as%20a%20faint%20line%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20overlay_path%20in%20overlay_paths%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scattergl(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtime_index_plot%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Doverlay_path%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dbrand.get(%22path_gray%22%2C%20%22rgba(0%2C0%2C0%2C0.07)%22)%2C%20width%3D0.7)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22skip%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%20%23%20All%20(WebGL)%20in%20a%20single%20batched%20trace%20via%20None%20separators%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_xs%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_ys%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20overlay_path%20in%20overlay_paths%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_xs.append(time_index_plot)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_ys.append(overlay_path)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_xs.append(%5BNone%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_ys.append(%5BNone%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_xs%20%3D%20np.concatenate(paths_xs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20paths_ys%20%3D%20np.concatenate(paths_ys)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scattergl(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dpaths_xs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dpaths_ys%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dbrand.get(%22path_gray%22%2C%20%22rgba(0%2C0%2C0%2C0.07)%22)%2C%20width%3D0.7)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22skip%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20withdrawal%20phase%20marker%0A%20%20%20%20%20%20%20%20if%20withdrawal_start_year.value%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.add_vline(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dwithdrawal_start_year.value%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_dash%3D%22dot%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_color%3D%22orange%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_text%3D%22Withdrawals%20Begin%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_position%3D%22top%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20fig.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Illustrative%20Portfolio%20Projections%20(Monte%20Carlo)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Years%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Portfolio%20Value%20(%24)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20hovermode%3D%22x%20unified%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D500%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DTrue%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis%3Ddict(tickformat%3D%22%24%2C.0f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20log_scale.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.update_yaxes(type%3D%22log%22)%0A%0A%20%20%20%20%20%20%20%20mo.ui.plotly(fig)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20mo.md(%22Waiting%20to%20run%3A%20press%20'Run%20simulation'.%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20base_fee_all%2C%0A%20%20%20%20diversified_pct%2C%0A%20%20%20%20english_mode%2C%0A%20%20%20%20growth_pct%2C%0A%20%20%20%20income_pct%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20sub_fee_diversified%2C%0A%20%20%20%20sub_fee_income%2C%0A%20%20%20%20target_final_value%2C%0A)%3A%0A%20%20%20%20final_values%20%3D%20None%0A%20%20%20%20stats%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20%23%20Calculate%20key%20statistics%0A%20%20%20%20%20%20%20%20final_values%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20-1%5D%0A%20%20%20%20%20%20%20%20initial%20%3D%20simulation_results%5B%22initial_value%22%5D%0A%20%20%20%20%20%20%20%20years%20%3D%20simulation_results%5B%22months%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20infl_stats%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20deflator_T%20%3D%20(1.0%20%2B%20infl_stats)%20**%20years%0A%20%20%20%20%20%20%20%20final_values_real%20%3D%20final_values%20%2F%20deflator_T%0A%0A%20%20%20%20%20%20%20%20%23%20Summary%20stats%0A%20%20%20%20%20%20%20%20weights%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22growth%22%3A%20float(growth_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22diversified%22%3A%20float(diversified_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22income%22%3A%20float(income_pct)%20%2F%20100.0%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20fee_annual%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20base_fee_all.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20weights%5B%22diversified%22%5D%20*%20sub_fee_diversified.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20weights%5B%22income%22%5D%20*%20sub_fee_income.value%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20gross_return%20%3D%20simulation_results%5B%22portfolio_return%22%5D%20*%20100.0%0A%20%20%20%20%20%20%20%20net_return_est%20%3D%20max(0.0%2C%20gross_return%20-%20fee_annual)%0A%0A%20%20%20%20%20%20%20%20stats%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Weighted%20illustrative%20return%20(gross)%22%3A%20f%22%7Bgross_return%3A.2f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Effective%20annual%20fee%20(weighted)%22%3A%20f%22%7Bfee_annual%3A.2f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Illustrative%20return%20(net%2C%20approx)%22%3A%20f%22%7Bnet_return_est%3A.2f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Portfolio%20Volatility%22%3A%20f%22%7Bsimulation_results%5B'portfolio_vol'%5D*100%3A.2f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Median%20Final%20Value%20(Nominal)%22%3A%20f%22%24%7Bnp.median(final_values)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Median%20Final%20Value%20(Real)%22%3A%20f%22%24%7Bnp.median(final_values_real)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%2295%25%20Range%20(Nominal)%22%3A%20f%22%24%7Bnp.percentile(final_values%2C%205)%3A%2C.0f%7D%20-%20%24%7Bnp.percentile(final_values%2C%2095)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Probability%20of%20Loss%20(vs%20initial)%22%3A%20f%22%7B(final_values%20%3C%20initial).mean()*100%3A.1f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20if%20not%20english_mode.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Detailed%20table%0A%20%20%20%20%20%20%20%20%20%20%20%20more%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Mean%20Final%20Value%20(Nominal)%22%3A%20f%22%24%7Bnp.mean(final_values)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Mean%20Final%20Value%20(Real)%22%3A%20f%22%24%7Bnp.mean(final_values_real)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Best%20Case%20(95th%20%25ile)%22%3A%20f%22%24%7Bnp.percentile(final_values%2C%2095)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Worst%20Case%20(5th%20%25ile)%22%3A%20f%22%24%7Bnp.percentile(final_values%2C%205)%3A%2C.0f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20stats.update(more)%0A%20%20%20%20%20%20%20%20%20%20%20%20import%20pandas%20as%20_pd%0A%20%20%20%20%20%20%20%20%20%20%20%20df_stats%20%3D%20_pd.DataFrame(%7B%22Metric%22%3A%20list(stats.keys())%2C%20%22Value%22%3A%20list(stats.values())%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%22%23%23%20%F0%9F%93%8A%20Portfolio%20Statistics%20(Nerd)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.table(data%3Ddf_stats)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20English%20summary%0A%20%20%20%20%20%20%20%20%20%20%20%20target%20%3D%20float(target_final_value.value)%0A%20%20%20%20%20%20%20%20%20%20%20%20final_vals_view%20%3D%20final_values_real%20if%20show_real.value%20else%20final_values%0A%20%20%20%20%20%20%20%20%20%20%20%20p_exceed_summary%20%3D%20(final_vals_view%20%3E%3D%20target).mean()%20*%20100.0%20if%20target%20%3E%200%20else%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20p5_stat%20%3D%20np.percentile(final_vals_view%2C%205)%0A%20%20%20%20%20%20%20%20%20%20%20%20p50_stat%20%3D%20np.percentile(final_vals_view%2C%2050)%0A%20%20%20%20%20%20%20%20%20%20%20%20p95_stat%20%3D%20np.percentile(final_vals_view%2C%2095)%0A%20%20%20%20%20%20%20%20%20%20%20%20units%20%3D%20%22real%20(today's%20%24)%22%20if%20show_real.value%20else%20%22nominal%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20bullets%20%3D%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Median%20ending%20value%3A%20%24%7Bp50_stat%3A%2C.0f%7D%20(%7Bunits%7D)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Typical%20range%3A%20%24%7Bp5_stat%3A%2C.0f%7D%20to%20%24%7Bp95_stat%3A%2C.0f%7D%20(90%25%20band)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Chance%20of%20finishing%20below%20start%3A%20%7B(final_values%20%3C%20initial).mean()*100%3A.1f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20p_exceed_summary%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20bullets.append(f%22Chance%20of%20beating%20target%20(%24%7Btarget%3A%2C.0f%7D)%3A%20%7Bp_exceed_summary%3A.1f%7D%25%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%5Cn%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%23%23%20%F0%9F%93%8A%20What%20this%20means%20(English)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22-%20%22%20%2B%20%22%5Cn-%20%22.join(bullets)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20brand%2C%0A%20%20%20%20english_mode%2C%0A%20%20%20%20go%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20target_final_value%2C%0A)%3A%0A%20%20%20%20colors%20%3D%20None%0A%20%20%20%20fig_dist%20%3D%20None%0A%20%20%20%20final_vals_hist%20%3D%20None%0A%20%20%20%20percentiles_to_mark%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20%23%20Create%20distribution%20of%20final%20values%0A%20%20%20%20%20%20%20%20final_vals_hist%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20-1%5D%0A%20%20%20%20%20%20%20%20infl_hist%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20horizon_years_hist%20%3D%20simulation_results%5B%22months%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20final_vals_hist%20%3D%20final_vals_hist%20%2F%20((1.0%20%2B%20infl_hist)%20**%20horizon_years_hist)%0A%0A%20%20%20%20%20%20%20%20fig_dist%20%3D%20go.Figure()%0A%20%20%20%20%20%20%20%20fig_dist.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20go.Histogram(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dfinal_vals_hist%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nbinsx%3D30%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22Final%20Portfolio%20Values%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker_color%3Dbrand.get(%22accent%22%2C%20%22%2314b8a6%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Range%3A%20%24%25%7Bx%3A%2C.0f%7D%3Cbr%3ECount%3A%20%25%7By%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20vertical%20lines%20for%20percentiles%0A%20%20%20%20%20%20%20%20percentiles_to_mark%20%3D%20%5B5%2C%2025%2C%2050%2C%2075%2C%2095%5D%0A%20%20%20%20%20%20%20%20colors%20%3D%20%5B%22red%22%2C%20%22orange%22%2C%20%22blue%22%2C%20%22green%22%2C%20%22darkgreen%22%5D%0A%0A%20%20%20%20%20%20%20%20for%20perc_mark%2C%20color%20in%20zip(percentiles_to_mark%2C%20colors)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20val%20%3D%20np.percentile(final_vals_hist%2C%20perc_mark)%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_dist.add_vline(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dval%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_dash%3D%22dash%22%20if%20perc_mark%20in%20%5B5%2C%2095%5D%20else%20%22solid%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_color%3Dbrand.get(%22muted%22%2C%20color)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_text%3Df%22%7Bperc_mark%7Dth%20%25ile%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_position%3D%22top%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Target%20line%20and%20exceedance%20probability%0A%20%20%20%20%20%20%20%20target_hist%20%3D%20float(target_final_value.value)%0A%20%20%20%20%20%20%20%20if%20target_hist%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20target_eff_hist%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_hist%20%2F%20((1.0%20%2B%20infl_hist)%20**%20horizon_years_hist)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20show_real.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20target_hist%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20exceed_pct%20%3D%20(final_vals_hist%20%3E%3D%20target_eff_hist).mean()%20*%20100.0%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_dist.add_vline(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtarget_eff_hist%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_dash%3D%22dot%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_color%3Dbrand.get(%22primary%22%2C%20%22%23581c87%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_text%3Df%22Target%20(P%E2%89%A5%3D%7Bexceed_pct%3A.1f%7D%25)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_position%3D%22top%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20fig_dist.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Distribution%20of%20Possible%20Final%20Values%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Final%20Portfolio%20Value%20(%24)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Number%20of%20Simulations%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis%3Ddict(tickformat%3D%22%24%2C.0f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D400%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20not%20english_mode.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%23%20%F0%9F%8E%AF%20Final%20Value%20Distribution%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20This%20histogram%20shows%20the%20range%20of%20possible%20outcomes%20at%20the%20end%20of%20the%20simulation%20period.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20mo.ui.plotly(fig_dist)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20brand%2C%0A%20%20%20%20english_mode%2C%0A%20%20%20%20go%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20target_final_value%2C%0A)%3A%0A%20%20%20%20%23%20Final%20value%20CDF%20(exceedance%20curve)%20clarifies%20probabilities%0A%20%20%20%20fig_cdf%20%3D%20None%0A%20%20%20%20if%20simulation_results%3A%0A%20%20%20%20%20%20%20%20final_vals_cdf%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20-1%5D%0A%20%20%20%20%20%20%20%20infl_cdf%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20horizon_years_cdf%20%3D%20simulation_results%5B%22months%22%5D%20%2F%2012.0%0A%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20final_vals_cdf%20%3D%20final_vals_cdf%20%2F%20((1.0%20%2B%20infl_cdf)%20**%20horizon_years_cdf)%0A%0A%20%20%20%20%20%20%20%20cdf_xs%20%3D%20np.sort(final_vals_cdf)%0A%20%20%20%20%20%20%20%20cdf%20%3D%20np.arange(1%2C%20len(cdf_xs)%20%2B%201)%20%2F%20len(cdf_xs)%0A%20%20%20%20%20%20%20%20exceedance_y%20%3D%201.0%20-%20cdf%0A%0A%20%20%20%20%20%20%20%20fig_cdf%20%3D%20go.Figure()%0A%20%20%20%20%20%20%20%20fig_cdf.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dcdf_xs%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dexceedance_y%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dbrand.get(%22accent%22%2C%20%22%2314b8a6%22)%2C%20width%3D2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22P(Final%20%E2%89%A5%20x)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22x%3A%20%24%25%7Bx%3A%2C.0f%7D%3Cbr%3EP%E2%89%A5x%3A%20%25%7By%3A.2f%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20target_cdf%20%3D%20float(target_final_value.value)%0A%20%20%20%20%20%20%20%20if%20target_cdf%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20target_eff_cdf%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_cdf%20%2F%20((1.0%20%2B%20infl_cdf)%20**%20horizon_years_cdf)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20show_real.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20target_cdf%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20p_exceed_cdf%20%3D%20(final_vals_cdf%20%3E%3D%20target_eff_cdf).mean()%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_cdf.add_vline(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dtarget_eff_cdf%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_dash%3D%22dot%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line_color%3Dbrand.get(%22primary%22%2C%20%22%23581c87%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_text%3Df%22Target%20(P%E2%89%A5%3D%7Bp_exceed_cdf*100%3A.1f%7D%25)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20annotation_position%3D%22top%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20fig_cdf.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Exceedance%20of%20Possible%20Final%20Values%20(1%20%E2%88%92%20CDF)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Final%20Portfolio%20Value%20(%24)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Probability%20of%20Exceedance%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20xaxis%3Ddict(tickformat%3D%22%24%2C.0f%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D380%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20if%20not%20english_mode.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.plotly(fig_cdf)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20boxplot_step_years%2C%0A%20%20%20%20brand%2C%0A%20%20%20%20go%2C%0A%20%20%20%20inflation_rate%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20np%2C%0A%20%20%20%20show_real%2C%0A%20%20%20%20simulation_results%2C%0A%20%20%20%20withdrawal_start_year%2C%0A)%3A%0A%20%20%20%20depleted%20%3D%20None%0A%20%20%20%20fig_survival%20%3D%20None%0A%20%20%20%20success_rate%20%3D%20None%0A%20%20%20%20survival_rates%20%3D%20None%0A%20%20%20%20withdrawal_month%20%3D%20None%0A%20%20%20%20withdrawal_values%20%3D%20None%0A%20%20%20%20years_in_withdrawal%20%3D%20None%0A%0A%20%20%20%20if%20simulation_results%20and%20withdrawal_start_year.value%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%23%20Analyze%20withdrawal%20phase%20success%0A%20%20%20%20%20%20%20%20withdrawal_month%20%3D%20int(withdrawal_start_year.value%20*%2012)%0A%20%20%20%20%20%20%20%20if%20withdrawal_month%20%3C%20simulation_results%5B%22all_results%22%5D.shape%5B1%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20withdrawal_values%20%3D%20simulation_results%5B%22all_results%22%5D%5B%3A%2C%20withdrawal_month%3A%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Adjust%20for%20real%20values%20if%20requested%20(deflate%20by%20month)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20show_real.value%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20infl_withdraw%20%3D%20inflation_rate.value%20%2F%20100.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20t_w%20%3D%20np.arange(withdrawal_values.shape%5B1%5D)%20%2F%2012.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20deflator_withdraw%20%3D%20(1.0%20%2B%20infl_withdraw)%20**%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20t_w%20%2B%20withdrawal_start_year.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20withdrawal_values%20%3D%20withdrawal_values%20%2F%20deflator_withdraw%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Check%20how%20many%20simulations%20run%20out%20of%20money%0A%20%20%20%20%20%20%20%20%20%20%20%20depleted%20%3D%20(withdrawal_values%20%3C%3D%200).any(axis%3D1)%0A%20%20%20%20%20%20%20%20%20%20%20%20success_rate%20%3D%20(1%20-%20depleted.mean())%20*%20100%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Create%20survival%20chart%0A%20%20%20%20%20%20%20%20%20%20%20%20months_in_withdrawal%20%3D%20withdrawal_values.shape%5B1%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20survival_rates%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20years_in_withdrawal%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20step_idx%20in%20range(months_in_withdrawal)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20surviving%20%3D%20(withdrawal_values%5B%3A%2C%20step_idx%5D%20%3E%200).mean()%20*%20100%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20survival_rates.append(surviving)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20years_in_withdrawal.append(step_idx%20%2F%2012.0)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_survival%20%3D%20go.Figure()%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_survival.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Scatter(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dyears_in_withdrawal%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dsurvival_rates%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(color%3Dbrand.get(%22accent%22%2C%20%22%2314b8a6%22)%2C%20width%3D2)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fill%3D%22tozeroy%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fillcolor%3Dbrand.get(%22band_fill%22%2C%20%22rgba(120%2C120%2C120%2C0.35)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22Portfolio%20Survival%20Rate%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Years%3A%20%25%7Bx%3A.1f%7D%3Cbr%3ESurvival%20Rate%3A%20%25%7By%3A.1f%7D%25%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig_survival.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Portfolio%20Survival%20Rate%20During%20Withdrawal%20Phase%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Years%20into%20Withdrawal%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Percentage%20of%20Portfolios%20Still%20Funded%20(%25)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height%3D400%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20yaxis%3Ddict(range%3D%5B0%2C%20105%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%23%20%F0%9F%92%B0%20Withdrawal%20Phase%20Analysis%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20**Success%20Rate%3A**%20%7Bsuccess_rate%3A.1f%7D%25%20of%20portfolios%20maintained%20positive%20balance%20throughout%20withdrawal%20phase%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.plotly(fig_survival)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Time-to-depletion%20histogram%20(for%20those%20that%20deplete)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20depleted.any()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Find%20first%20depletion%20month%20per%20sim%20(NaN%20if%20never)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20first_zero_idx%20%3D%20np.argmax(withdrawal_values%20%3C%3D%200%2C%20axis%3D1)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20a%20row%20never%20depletes%2C%20argmax%20gives%200%3B%20mask%20those%20using%20depleted%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ttd_years%20%3D%20first_zero_idx%5Bdepleted%5D%20%2F%2012.0%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig_ttd%20%3D%20go.Figure()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig_ttd.add_trace(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20go.Histogram(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dttd_years%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20nbinsx%3Dmax(5%2C%20int(withdrawal_values.shape%5B1%5D%20%2F%20(12%20*%20boxplot_step_years.value)))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker_color%3Dbrand.get(%22warning%22%2C%20%22%23f59e0b%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name%3D%22Time%20to%20depletion%20(years)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D%22Years%3A%20%25%7Bx%3A.1f%7D%3Cbr%3ECount%3A%20%25%7By%7D%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fig_ttd.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Distribution%3A%20Time%20to%20Depletion%20(possible%20outcomes)%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20xaxis_title%3D%22Years%20from%20withdrawal%20start%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20yaxis_title%3D%22Count%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20template%3D%22plotly_white%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height%3D350%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mo.ui.plotly(fig_ttd)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%20%F0%9F%93%9A%20Understanding%20the%20Results%0A%0A%20%20%20%20%23%23%23%20Sequence%20of%20Returns%20Risk%0A%20%20%20%20The%20Monte%20Carlo%20simulation%20shows%20how%20the%20**order**%20of%20returns%20matters%2C%20not%20just%20the%20average.%0A%20%20%20%20Two%20portfolios%20with%20the%20same%20average%20return%20can%20have%20vastly%20different%20outcomes%20depending%20on%20when%0A%20%20%20%20good%20and%20bad%20years%20occur.%0A%0A%20%20%20%20%23%23%23%20Reading%20the%20Charts%0A%20%20%20%20-%20**Gray%20lines**%3A%20Individual%20simulation%20paths%20showing%20possible%20futures%0A%20%20%20%20-%20**Blue%20line**%3A%20Median%20outcome%20(50%25%20of%20simulations%20above%2C%2050%25%20below)%0A%20%20%20%20-%20**Green%20bands**%3A%20Likely%20range%20of%20outcomes%20(25th-75th%20percentile)%0A%20%20%20%20-%20**Red%2FGreen%20dashed**%3A%20Extreme%20outcomes%20(5th%20and%2095th%20percentiles)%0A%0A%20%20%20%20%23%23%23%20Key%20Insights%0A%20%20%20%201.%20**Wide%20range%20of%20outcomes**%3A%20Even%20with%20the%20same%20strategy%2C%20results%20vary%20significantly%0A%20%20%20%202.%20**Time%20matters**%3A%20Longer%20time%20horizons%20generally%20lead%20to%20better%20outcomes%20but%20also%20wider%20ranges%0A%20%20%20%203.%20**Withdrawal%20timing**%3A%20Starting%20withdrawals%20during%20market%20downturns%20can%20severely%20impact%20portfolio%20longevity%0A%20%20%20%204.%20**Diversification%20benefit**%3A%20Mixing%20asset%20classes%20can%20reduce%20volatility%20while%20maintaining%20returns%0A%0A%20%20%20%20%23%23%23%20Limitations%0A%20%20%20%20-%20Based%20on%20historical%20approximations%3B%20future%20returns%20may%20differ%0A%20%20%20%20-%20Assumes%20constant%20allocation%20(no%20rebalancing%20shown)%0A%20%20%20%20-%20Does%20not%20account%20for%20taxes%20or%20fees%0A%20%20%20%20-%20Simplified%20correlation%20model%20between%20asset%20classes%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%20Portfolio%20Monte%20Carlo%20simulation%20parameters%20from%20historical%20data%0A%0A%20%20%20%20Monte%20Carlo%20simulations%20require%20accurate%20parameter%20inputs%20to%20generate%20reliable%20portfolio%20projections.%20Based%20on%20comprehensive%20research%20across%20academic%20literature%2C%20investment%20firms%2C%20and%20historical%20market%20data%2C%20the%20most%20critical%20finding%20is%20that%20**traditional%20normal%20distribution%20assumptions%20underestimate%20portfolio%20risk%20by%2020-50%25**%2C%20with%20extreme%20events%20occurring%205-10%20times%20more%20frequently%20than%20standard%20models%20predict.%20The%20following%20parameters%2C%20derived%20from%20empirical%20evidence%20spanning%201926-2024%2C%20provide%20the%20quantitative%20foundation%20for%20robust%20portfolio%20simulation%20models.%0A%0A%20%20%20%20%23%23%20Asset%20class%20return%20distributions%20reveal%20consistent%20non-normality%0A%0A%20%20%20%20Historical%20analysis%20of%20equity%20returns%20demonstrates%20pronounced%20deviations%20from%20normal%20distributions%20across%20all%20major%20asset%20classes.%20**Growth%20stocks%20exhibit%20negative%20skewness%20of%20-0.5%20to%20-1.0%20with%20excess%20kurtosis%20of%201.5%20to%203.0**%2C%20indicating%20more%20frequent%20and%20severe%20left-tail%20events%20than%20normal%20distributions%20predict.%20The%20Russell%201000%20Growth%20Index%20shows%20compound%20annual%20returns%20of%20**9.31%25%20with%2017%25%20standard%20deviation**%20over%20long%20periods%2C%20but%20these%20averages%20mask%20significant%20regime%20variations%20and%20tail%20risks.%0A%0A%20%20%20%20Technology%20sector%20equities%20display%20even%20more%20extreme%20characteristics%2C%20with%20the%20NASDAQ%20showing%20**excess%20kurtosis%20of%202.0%20to%204.0**%20due%20to%20pronounced%20boom-bust%20cycles.%20Small-cap%20growth%20stocks%20demonstrate%20the%20highest%20volatility%20parameters%2C%20with%20annual%20standard%20deviations%20of%20**18-25%25**%20and%20excess%20kurtosis%20reaching%20**2.5%20to%205.0**.%20Maximum%20drawdowns%20for%20these%20concentrated%20equity%20positions%20have%20historically%20exceeded%20**60%25%20in%20major%20corrections**%2C%20with%20recovery%20periods%20spanning%202-4%20years.%0A%0A%20%20%20%20Diversified%20equity%20portfolios%20show%20somewhat%20moderated%20but%20still%20significant%20non-normal%20characteristics.%20S%26P%20500%20returns%20from%201982-2001%20exhibited%20conventional%20skewness%20of%20**-2.39%20and%20kurtosis%20of%2053.62**%20when%20including%20all%20observations%2C%20though%20removing%20the%201987%20crash%20reduces%20these%20to%20**-0.26%20and%206.80**%20respectively.%20International%20developed%20markets%20show%20**skewness%20of%20-0.67%20with%20kurtosis%20of%203.59**%20when%20currency-hedged%2C%20while%20emerging%20markets%20surprisingly%20display%20**positive%20skewness%20of%200.56**%20despite%20higher%20overall%20volatility%20of%20**21-22%25%20annually**.%0A%0A%20%20%20%20Fixed%20income%20assets%20present%20different%20distribution%20challenges.%20Investment-grade%20bonds%20show%20relatively%20normal%20distributions%20with%20modest%20excess%20kurtosis%20of%20**2-4**%2C%20but%20high-yield%20bonds%20exhibit%20fat-tail%20characteristics%20similar%20to%20equities.%20The%20current%20Bloomberg%20Aggregate%20Bond%20Index%20duration%20of%20**approximately%206%20years**%20compares%20to%20a%20long-term%20average%20of%204.97%20years%2C%20creating%20heightened%20interest%20rate%20sensitivity.%20International%20bonds%20add%20**10-15%25%20additional%20volatility**%20when%20unhedged%20due%20to%20currency%20effects.%0A%0A%20%20%20%20Alternative%20investments%20require%20special%20consideration%20in%20Monte%20Carlo%20models.%20Real%20estate%20investment%20trusts%20historically%20delivered%20**11.1%25%20annual%20returns%20with%2013.5-16.6%25%20volatility**%2C%20showing%20correlations%20with%20broad%20equities%20ranging%20from%20**44%25%20to%2066%25**%20depending%20on%20market%20conditions.%20Commodities%20exhibit%20unique%20challenges%20with%20contango%20conditions%20costing%20investors%20approximately%20**6.87%25%20annually%20since%201998**%20through%20negative%20roll%20yields.%20Hedge%20fund%20indices%20show%20survivorship%20bias%20requiring%20**1-3%25%20downward%20adjustment**%20to%20historical%20returns%2C%20while%20private%20equity%20demonstrates%20J-curve%20effects%20with%20typical%20hold%20periods%20of%207-10%20years.%0A%0A%20%20%20%20%23%23%20Correlation%20dynamics%20and%20volatility%20clustering%20drive%20modeling%20accuracy%0A%0A%20%20%20%20Asset%20correlations%20vary%20dramatically%20across%20market%20regimes%2C%20fundamentally%20affecting%20portfolio%20risk.%20During%20normal%20market%20conditions%2C%20stock-bond%20correlations%20range%20from%20**-0.2%20to%20%2B0.4**%2C%20providing%20diversification%20benefits.%20However%2C%20during%20the%202008%20financial%20crisis%2C%20correlations%20across%20risk%20assets%20approached%20**1.0**%2C%20with%20real%20estate%20REITs%20showing%20near-perfect%20correlation%20with%20equities%20instead%20of%20providing%20anticipated%20diversification.%20The%202020%20COVID%20crisis%20saw%20initial%20correlation%20spikes%20to%20**0.8-0.9**%20across%20most%20risk%20assets%20before%20rapid%20normalization%20due%20to%20unprecedented%20stimulus.%0A%0A%20%20%20%20Volatility%20clustering%20follows%20predictable%20GARCH(1%2C1)%20patterns%20with%20**%CE%B1%20coefficients%20of%200.05-0.15%20and%20%CE%B2%20coefficients%20of%200.80-0.95**%20for%20most%20equity%20series%2C%20creating%20persistence%20parameters%20typically%20between%20**0.90-0.99**.%20The%20VIX%20index%20shows%20mean%20reversion%20with%20a%20half-life%20of%20**7.6%20days**%20toward%20its%20long-run%20mean%20of%20approximately%20**14.6**%2C%20though%20it%20typically%20trades%20at%20a%20**1-4%20point%20premium**%20to%20subsequent%20realized%20volatility.%20These%20clustering%20effects%20persist%20with%20autocorrelation%20in%20absolute%20returns%20lasting%20**10-15%20months**%20for%20most%20financial%20series.%0A%0A%20%20%20%20Market%20regime%20identification%20proves%20crucial%20for%20accurate%20modeling.%20Bear%20markets%2C%20defined%20as%2020%25%2B%20declines%2C%20last%20**6-12%20months%20for%20event-driven%20selloffs%20and%2012-18%20months%20for%20cyclical%20downturns**%2C%20with%20average%20decline%20magnitudes%20of%20approximately%20**30%25**.%20Interest%20rate%20regimes%20typically%20persist%20for%20**5-15%20years**%20with%20transition%20periods%20of%206-18%20months.%20Mean%20reversion%20half-lives%20vary%20significantly%20by%20asset%20class%3A%20**18.5%20years%20for%20US%20equities**%20during%20normal%20periods%20but%20as%20short%20as%202%20years%20during%20high%20uncertainty%2C%20while%20emerging%20markets%20show%20**30-month%20half-lives**%20and%20commodities%20exhibit%20**12-18%20month**%20mean%20reversion%20cycles.%0A%0A%20%20%20%20Momentum%20effects%20operate%20on%20different%20timescales%20with%20optimal%20lookback%20periods%20of%20**1-3%20months%20for%20short-term%2C%206-12%20months%20for%20medium-term%2C%20and%202-5%20years%20for%20long-term%20momentum**.%20Cross-asset%20momentum%20correlations%20of%20**0.3-0.5**%20suggest%20coordinated%20market%20movements%20that%20Monte%20Carlo%20models%20must%20capture%20through%20appropriate%20correlation%20matrices%20rather%20than%20independent%20sampling.%0A%0A%20%20%20%20%23%23%20Sequence%20of%20returns%20risk%20dominates%20retirement%20portfolio%20outcomes%0A%0A%20%20%20%20Research%20spanning%201871-2024%20reveals%20that%20**70%25%20of%20portfolio%20failures%20involve%20negative%20returns%20in%20the%20first%205%20years%20of%20retirement**.%20A%20100%25%20equity%20portfolio%20supports%20only%20a%20**3.1%25%20starting%20withdrawal%20rate**%20for%2090%25%20success%20over%2030%20years%2C%20significantly%20below%20the%20traditional%204%25%20rule.%20The%20risk%20increases%20dramatically%20with%20early%20losses%20-%20a%2015%25%20portfolio%20drop%20in%20year%20one%20combined%20with%20a%203.3%25%20withdrawal%20rate%20creates%20**6%20times%20higher%20failure%20risk**%20compared%20to%20positive%20early%20returns.%0A%0A%20%20%20%20Updated%20Trinity%20Study%20data%20confirms%20the%20**4%25%20rule%20remains%20viable%20for%2030-year%20periods**%20but%20requires%20high%20stock%20allocations%20of%2050-75%25.%20International%20analysis%20reveals%20sobering%20results%3A%20only%20**5%20countries%20historically%20supported%204%25%2B%20withdrawal%20rates**%20even%20with%20perfect%20foresight%20-%20Sweden%20(4.5%25)%2C%20Canada%20(4.4%25)%2C%20New%20Zealand%20(4.1%25)%2C%20Denmark%20(4.1%25)%2C%20and%20the%20United%20States%20(4.0%25).%20Global%20diversification%20improved%20success%20rates%20from%20**65.7%25%20to%2078.3%25**%20for%204%25%20withdrawals%2C%20still%20leaving%20substantial%20failure%20risk.%0A%0A%20%20%20%20CAPE%20ratio%20valuations%20show%20**0.77%20correlation%20with%20safe%20withdrawal%20rates**%2C%20providing%20more%20predictive%20power%20than%20for%20returns%20themselves.%20At%20CAPE%20ratios%20above%2020%2C%20the%204%25%20rule%20shows%20**37%25%20failure%20rates**%2C%20rising%20to%20**43.2%25%20when%20markets%20are%20also%20at%20all-time%20highs**.%20Current%20CAPE%20levels%20near%2027%20suggest%20withdrawal%20rates%20closer%20to%20**4.13%25**%20for%20traditional%20planning%20horizons.%20Dynamic%20strategies%20like%20Guyton-Klinger%20guardrails%20allow%20higher%20starting%20rates%20of%20**5.2-5.6%25**%20but%20historically%20required%20spending%20cuts%20up%20to%20**59%25%20in%20adverse%20scenarios**%20like%20the%201966%20cohort.%0A%0A%20%20%20%20Rising%20equity%20glidepaths%20from%20**30%25%20stocks%20at%20retirement%20to%2060%25%20over%2010%20years**%20prove%20most%20effective%20in%20high-valuation%20environments%2C%20while%20static%2060%25%20equity%20allocations%20perform%20well%20in%20favorable%20markets.%20Tax-efficient%20withdrawal%20sequencing%20can%20reduce%20taxes%20by%20**40%25%2B**%20and%20extend%20portfolio%20longevity%20by%201-2%20years%20through%20optimal%20ordering%20of%20account%20types.%0A%0A%20%20%20%20%23%23%20Implementation%20best%20practices%20enhance%20simulation%20accuracy%0A%0A%20%20%20%20Block%20bootstrapping%20with%20**3-6%20month%20blocks**%20captures%20serial%20correlation%20and%20mean%20reversion%20more%20effectively%20than%20traditional%20Monte%20Carlo's%20assumption%20of%20independent%20returns.%20Factor-specific%20optimal%20block%20sizes%20range%20from%20**1%20month%20for%20investment%20factors%20to%205-6%20months%20for%20low%20volatility%20strategies**.%20Circular%20bootstrapping%20prevents%20endpoint%20bias%20when%20sampling%20from%20limited%20historical%20data.%0A%0A%20%20%20%20Rebalancing%20studies%20consistently%20show%20**annual%20rebalancing%20as%20optimal**%2C%20with%20more%20frequent%20rebalancing%20increasing%20costs%20without%20proportional%20benefits.%20Threshold-based%20approaches%20using%20**5%25%20absolute%20deviation%20triggers**%20or%20**25%25%20relative%20triggers%20for%20small%20allocations**%20generated%20**56%20basis%20points%20of%20additional%20return**%20over%2010%20years%20in%20T.%20Rowe%20Price%20research.%20Volatility%20reduction%20of%20approximately%20**18%25**%20results%20from%20annual%20rebalancing%20versus%20buy-and-hold%20strategies.%0A%0A%20%20%20%20Inflation%20modeling%20requires%20distributional%20approaches%20rather%20than%20point%20estimates.%20The%201970s%20saw%20inflation%20ranging%20from%20**6.2%25%20to%2013.5%25**%20with%20high%20volatility%2C%20while%20the%202021-2023%20surge%20peaked%20at%20**9.1%25**%20before%20moderating.%20Tax-loss%20harvesting%20adds%20**1.08%25%20annually%20on%20average**%2C%20ranging%20from%20**0.51%25%20in%20low-volatility%20periods%20to%202.13%25%20during%20high-volatility%20markets**%20like%20the%20Great%20Depression%20era.%0A%0A%20%20%20%20Standard%20practice%20uses%20**10%2C000%20simulations**%20for%20most%20applications%2C%20with%20convergence%20studies%20showing%201%2C000%20sufficient%20for%20basic%20analysis%20and%20100%2C000%20for%20precision-critical%20applications.%20Monthly%20time%20steps%20provide%20optimal%20balance%20between%20computational%20efficiency%20and%20accuracy.%20Sensitivity%20analysis%20should%20test%20**%C2%B11-2%25%20variations%20in%20returns%20and%20%C2%B120-50%25%20variations%20in%20volatility**%20to%20assess%20model%20robustness.%0A%0A%20%20%20%20%23%23%20Extreme%20events%20provide%20critical%20tail%20risk%20parameters%0A%0A%20%20%20%20Historical%20market%20crashes%20demonstrate%20the%20severity%20of%20tail%20events%20that%20Monte%20Carlo%20simulations%20must%20capture.%20The%201929%20crash%20saw%20**89%25%20peak-to-trough%20decline**%20with%2025-year%20recovery%20to%20previous%20highs.%20Black%20Monday%201987%20produced%20a%20**22.6%25%20single-day%20decline**%2C%20the%20largest%20percentage%20drop%20in%20history.%20The%202000-2002%20dot-com%20crash%20erased%20**49%25%20from%20the%20S%26P%20500%20and%2078%25%20from%20NASDAQ**%2C%20while%202008's%20financial%20crisis%20created%20a%20**57%25%20drawdown**%20over%2017%20months.%20The%202020%20COVID%20crash%20compressed%20a%20**34%25%20decline%20into%20just%20one%20month**%20before%20the%20fastest%20recovery%20in%20history.%0A%0A%20%20%20%20Interest%20rate%20shocks%20create%20different%20risk%20patterns.%20The%20Volcker%20era%20saw%20federal%20funds%20rates%20peak%20at%20**19.1%25%20in%20June%201981**%2C%20successfully%20reducing%20inflation%20from%2014%25%20to%203%25%20but%20causing%20back-to-back%20recessions.%20The%202013%20taper%20tantrum%20drove%20**100%20basis%20point%20rate%20increases**%20in%20just%20four%20months%2C%20while%202022's%20rate%20increases%20proceeded%20at%20the%20**fastest%20pace%20in%2040%20years**%20with%20multiple%2075%20basis%20point%20hikes.%0A%0A%20%20%20%20Currency%20effects%20add%20complexity%20to%20international%20portfolios.%20Hedging%20reduces%20volatility%20substantially%20for%20quarterly%20horizons%20with%20benefits%20persisting%20to%205-year%20periods%2C%20contradicting%20earlier%20research%20suggesting%20mean%20reversion%20eliminates%20long-term%20hedging%20benefits.%20Hedging%20costs%20depend%20on%20interest%20rate%20differentials%2C%20with%20collar%20strategies%20providing%20optimal%20risk-adjusted%20returns.%20Static%20**100%25%20hedging%20for%20fixed%20income**%20and%20dynamic%20hedging%20for%20equities%20based%20on%20correlation%20changes%20represents%20current%20best%20practice.%0A%0A%20%20%20%20%23%23%20Conclusion%0A%0A%20%20%20%20Monte%20Carlo%20simulations%20achieve%20maximum%20accuracy%20when%20incorporating%20these%20empirically-derived%20parameters%20rather%20than%20simplified%20normal%20distribution%20assumptions.%20The%20data%20reveals%20consistent%20patterns%3A%20negative%20skewness%20and%20excess%20kurtosis%20across%20most%20asset%20classes%2C%20time-varying%20correlations%20that%20spike%20during%20crises%2C%20sequence%20risk%20that%20dominates%20retirement%20outcomes%2C%20and%20extreme%20events%20occurring%20far%20more%20frequently%20than%20traditional%20models%20predict.%20Implementing%20block%20bootstrapping%2C%20regime-switching%20models%2C%20and%20fat-tailed%20distributions%20while%20maintaining%20**10%2C000%2B%20simulation%20runs**%20creates%20robust%20portfolio%20projections%20that%20better%20reflect%20the%20complex%20realities%20of%20financial%20markets.%20These%20parameters%2C%20drawn%20from%20nearly%20a%20century%20of%20market%20data%2C%20provide%20the%20quantitative%20foundation%20for%20investment%20planning%20that%20appropriately%20balances%20risk%20and%20return%20in%20an%20uncertain%20world.%20can%20you%20add%20this%20as%20a%20markdown%20cell%20at%20the%20bottom%20and%20als%20use%20this%20as%20the%20source%20of%20the%20growth%20income%20and%20diversification%20strategy%20(only%20w%2F%201%25%20fees%20and%20no%20commmissions%20on%20all%20strategies.%20add%20a%20%22sub-manager%20fee%22%20for%20both%20diversification%20and%20income%20I'll%20conduct%20detailed%20research%20on%20the%20specific%20parameters%20and%20historical%20characteristics%20of%20these%20three%20investment%20strategies%20for%20your%20Monte%20Carlo%20simulation.Based%20on%20my%20research%2C%20here%20are%20the%20recommended%20parameters%20for%20your%20three%20investment%20strategies%20in%20the%20Monte%20Carlo%20simulation%3A%0A%0A%20%20%20%20%23%23%20**1.%20Actively%20Managed%2025-Stock%20Strategy%20(Concentrated%20Equity)**%0A%0A%20%20%20%20%23%23%23%20Historical%20Parameters%3A%0A%20%20%20%20-%20**Illustrative%20Annual%20Return**%3A%2011-13%25%20(use%2012%25)%0A%20%20%20%20-%20**Annual%20Volatility**%3A%2022-28%25%20(use%2025%25)%0A%20%20%20%20-%20**Skewness**%3A%20-0.8%20(negative%2C%20indicating%20more%20frequent%20downside%20surprises)%0A%20%20%20%20-%20**Excess%20Kurtosis**%3A%202.5%20(fat%20tails%20-%20extreme%20events%20more%20common)%0A%20%20%20%20-%20**Maximum%20Drawdown%20Risk**%3A%2040-60%25%20in%20severe%20corrections%0A%0A%20%20%20%20%23%23%23%20Key%20Characteristics%3A%0A%20%20%20%20-%20Individual%20stocks%20in%20concentrated%20portfolios%20experience%204%2B%20drawdowns%20of%2010%25%20or%20more%20even%20in%20strong%20years%0A%20%20%20%20-%2072-96%25%20of%20individual%20stocks%20have%2015%25%2B%20drawdowns%20annually%2C%20even%20in%20bull%20markets%0A%20%20%20%20-%20Volatility%20drag%20significantly%20impacts%20long-term%20returns%20-%20a%20stock%20up%2050%25%20then%20down%2050%25%20loses%2025%25%20overall%0A%20%20%20%20-%20Concentrated%20portfolios%20tend%20to%20cluster%20in%20popular%20growth%20names%2C%20creating%20boom-bust%20cycles%0A%0A%20%20%20%20%23%23%20**2.%20Global%20Tactical%20Asset%20Allocation%20(GTAA)**%0A%0A%20%20%20%20%23%23%23%20Historical%20Parameters%3A%0A%20%20%20%20-%20**Illustrative%20Annual%20Return**%3A%208-10%25%20(use%209%25)%0A%20%20%20%20-%20**Annual%20Volatility**%3A%207-12%25%20(use%2010%25)%0A%20%20%20%20-%20**Skewness**%3A%20-0.3%20(slightly%20negative)%0A%20%20%20%20-%20**Excess%20Kurtosis**%3A%201.0%20(moderate%20fat%20tails)%0A%20%20%20%20-%20**Sharpe%20Ratio**%3A%200.8-1.2%20historically%0A%0A%20%20%20%20%23%23%23%20Key%20Characteristics%3A%0A%20%20%20%20-%20Beta%20to%20global%20markets%20typically%200.8%2C%20providing%20downside%20protection%0A%20%20%20%20-%20Best%20performance%20during%20market%20stress%20and%20regime%20changes%0A%20%20%20%20-%2040-year%20backtests%20show%20worst%20annual%20loss%20of%20-5.76%25%20for%20aggressive%20versions%0A%20%20%20%20-%20Correlation%20to%20traditional%20portfolios%3A%200.4-0.6%0A%20%20%20%20-%20Rebalancing%20monthly%20across%206-13%20asset%20classes%20based%20on%20momentum%20signals%0A%0A%20%20%20%20%23%23%20**3.%20Income%20Strategy%20(Bond-Heavy%20Portfolio)**%0A%0A%20%20%20%20%23%23%23%20Historical%20Parameters%3A%0A%20%20%20%20-%20**Illustrative%20Annual%20Return**%3A%205-7%25%20(use%206%25)%0A%20%20%20%20-%20**Annual%20Volatility**%3A%204-8%25%20(use%206%25)%0A%20%20%20%20-%20**Skewness**%3A%200.1%20(nearly%20symmetric)%0A%20%20%20%20-%20**Excess%20Kurtosis**%3A%200.5%20(slight%20fat%20tails)%0A%20%20%20%20-%20**Maximum%20Drawdown**%3A%2010-15%25%20in%20rate%20shock%20scenarios%0A%0A%20%20%20%20%23%23%23%20Composition%20Assumptions%20(typical%20income%20portfolio)%3A%0A%20%20%20%20-%2030%25%20dividend%20stocks%20(7-8%25%20return%2C%2012%25%20volatility)%0A%20%20%20%20-%2050%25%20investment-grade%20bonds%20(4-5%25%20return%2C%204%25%20volatility)%0A%20%20%20%20-%2020%25%20high-yield%20bonds%20(6-7%25%20return%2C%208%25%20volatility)%0A%0A%20%20%20%20%23%23%20**Critical%20Additional%20Parameters%20to%20Consider**%0A%0A%20%20%20%20%23%23%23%20Correlation%20Matrix%20(Normal%20Markets)%3A%0A%20%20%20%20%60%60%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2025-Stock%20%20GTAA%20%20%20Income%0A%20%20%20%2025-Stock%20Strategy%20%20%20%20%20%201.00%20%20%200.60%20%20%20%200.40%0A%20%20%20%20GTAA%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200.60%20%20%201.00%20%20%20%200.30%20%20%0A%20%20%20%20Income%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%200.40%20%20%200.30%20%20%20%201.00%0A%20%20%20%20%60%60%60%0A%0A%20%20%20%20%23%23%23%20Crisis%20Correlations%20(2008-style%20event)%3A%0A%20%20%20%20-%20All%20correlations%20increase%20by%200.2-0.4%0A%20%20%20%20-%20Stock%20strategies%20correlation%20approaches%200.9%0A%20%20%20%20-%20Bonds%20may%20temporarily%20correlate%20at%200.6%2B%20with%20stocks%0A%0A%20%20%20%20%23%23%23%20Volatility%20Clustering%20Parameters%3A%0A%20%20%20%20-%20Use%20GARCH(1%2C1)%20with%20%CE%B1%20%3D%200.10%2C%20%CE%B2%20%3D%200.85%0A%20%20%20%20-%20Volatility%20persistence%20%3D%200.95%0A%20%20%20%20-%20High%20volatility%20regimes%20last%203-6%20months%20on%20average%0A%0A%20%20%20%20%23%23%23%20Sequence%20of%20Returns%20Adjustments%3A%0A%20%20%20%20-%20First%205%20years%20matter%20most%20for%20withdrawal%20strategies%0A%20%20%20%20-%20Apply%2020%25%20penalty%20to%20assumed%20returns%20in%20high%20valuation%20environments%20(CAPE%20%3E%2025)%0A%20%20%20%20-%20Increase%20volatility%20by%2030%25%20in%20first%203%20years%20of%20retirement%20phase%0A%0A%20%20%20%20%23%23%20**Best%20Practices%20for%20Implementation**%0A%0A%20%20%20%201.%20**Use%20Block%20Bootstrapping**%3A%20Sample%203-month%20blocks%20from%20historical%20data%20rather%20than%20individual%20monthly%20returns%20to%20preserve%20serial%20correlation%0A%0A%20%20%20%202.%20**Implement%20Fat%20Tails**%3A%20Use%20Student's%20t-distribution%20with%205-7%20degrees%20of%20freedom%20rather%20than%20normal%20distribution%2C%20or%20mixture%20models%20combining%20normal%20and%20jump%20components%0A%0A%20%20%20%203.%20**Dynamic%20Correlations**%3A%20Increase%20correlations%20by%20this%20formula%20during%20drawdowns%3A%0A%20%20%20%20%20%20%20%60%60%60%0A%20%20%20%20%20%20%20Crisis_Correlation%20%3D%20Normal_Correlation%20%2B%200.3%20%C3%97%20(1%20-%20Normal_Correlation)%20%C3%97%20Market_Stress_Indicator%0A%20%20%20%20%20%20%20%60%60%60%0A%0A%20%20%20%204.%20**Rebalancing%20Assumptions**%3A%0A%20%20%20%20%20%20%20-%2025-Stock%3A%20Quarterly%20rebalancing%20with%202%25%20threshold%20triggers%0A%20%20%20%20%20%20%20-%20GTAA%3A%20Monthly%20momentum%20rebalancing%0A%20%20%20%20%20%20%20-%20Income%3A%20Annual%20rebalancing%20or%205%25%20deviation%20triggers%0A%0A%20%20%20%205.%20**Cost%20Adjustments**%3A%0A%20%20%20%20%20%20%20-%2025-Stock%3A%201.5%25%20annual%20fees%20%2B%200.5%25%20trading%20costs%0A%20%20%20%20%20%20%20-%20GTAA%3A%200.8%25%20management%20fee%20%2B%200.3%25%20trading%20costs%20%20%0A%20%20%20%20%20%20%20-%20Income%3A%200.5%25%20fees%20%2B%200.1%25%20trading%20costs%0A%0A%20%20%20%206.%20**Tax%20Drag**%20(if%20applicable)%3A%0A%20%20%20%20%20%20%20-%2025-Stock%3A%201.2%25%20annual%20tax%20drag%20from%20turnover%0A%20%20%20%20%20%20%20-%20GTAA%3A%200.8%25%20(more%20tax-efficient)%0A%20%20%20%20%20%20%20-%20Income%3A%201.5%25%20(ordinary%20income%20treatment)%0A%0A%20%20%20%20%23%23%20**Recommended%20Simulation%20Adjustments**%0A%0A%20%20%20%20For%20more%20realistic%20results%20than%20simple%20Monte%20Carlo%3A%0A%0A%20%20%20%201.%20**Regime%20Switching**%3A%20Implement%203%20regimes%20(bull%2Fnormal%2Fbear)%20with%20transition%20probabilities%0A%20%20%20%202.%20**Mean%20Reversion**%3A%20Apply%200.03%20coefficient%20to%20returns%20(3%25%20pull%20toward%20long-term%20mean)%0A%20%20%20%203.%20**Valuation%20Adjustment**%3A%20Reduce%20forward%20returns%20by%20(Current_PE%20%2F%20Historical_PE%20-%201)%20%C3%97%200.3%0A%20%20%20%204.%20**Inflation%20Scenarios**%3A%20Model%203%20inflation%20regimes%20with%20different%20asset%20class%20responses%0A%20%20%20%205.%20**Liquidity%20Constraints**%3A%20In%20crisis%20scenarios%2C%20reduce%20ability%20to%20rebalance%20by%2050%25%0A%0A%20%20%20%20These%20parameters%20will%20give%20you%20much%20more%20realistic%20portfolio%20projections%20than%20using%20simple%20normal%20distributions%20with%20constant%20parameters.%20The%20concentrated%20equity%20strategy%20offers%20highest%20potential%20returns%20but%20with%20severe%20drawdown%20risk%2C%20GTAA%20provides%20the%20best%20risk-adjusted%20returns%2C%20and%20the%20income%20strategy%20offers%20stability%20but%20may%20struggle%20to%20keep%20pace%20with%20inflation%20over%20long%20periods.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Load%20Ethical%20Capital%20brand%20palette%20(JSON)%2C%20with%20safe%20fallbacks%0A%20%20%20%20import%20json%2C%20os%0A%20%20%20%20brand%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22primary%22%3A%20%22%23581c87%22%2C%20%20%23%20ECIC%20Purple%0A%20%20%20%20%20%20%20%20%22accent%22%3A%20%22%2314b8a6%22%2C%20%20%20%23%20ECIC%20Teal%0A%20%20%20%20%20%20%20%20%22warning%22%3A%20%22%23f59e0b%22%2C%20%20%23%20Amber%0A%20%20%20%20%20%20%20%20%22danger%22%3A%20%22%23ef4444%22%2C%0A%20%20%20%20%20%20%20%20%22text%22%3A%20%22%23111827%22%2C%0A%20%20%20%20%20%20%20%20%22muted%22%3A%20%22%234b5563%22%2C%0A%20%20%20%20%20%20%20%20%22surface%22%3A%20%22%23ffffff%22%2C%0A%20%20%20%20%20%20%20%20%22surface_light%22%3A%20%22%23f9fafb%22%2C%0A%20%20%20%20%20%20%20%20%22border%22%3A%20%22%23e5e7eb%22%2C%0A%20%20%20%20%7D%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20brand_palette_path%20%3D%20os.path.join(%22Ethical-Capital-Brand-Kit%22%2C%20%22palette%22%2C%20%22palette.json%22)%0A%20%20%20%20%20%20%20%20if%20os.path.exists(brand_palette_path)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20with%20open(brand_palette_path%2C%20%22r%22)%20as%20f%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pal_json%20%3D%20json.load(f)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20pal%20%3D%20pal_json.get(%22palette%22%2C%20%7B%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20sem%20%3D%20pal_json.get(%22semantic%22%2C%20%7B%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22primary%22%5D%20%3D%20sem.get(%22primary%22%2C%20pal.get(%22ecic-purple%22%2C%20brand%5B%22primary%22%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Prefer%20solid%20teal%20accent%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22accent%22%5D%20%3D%20pal.get(%22ecic-teal%22%2C%20brand%5B%22accent%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22warning%22%5D%20%3D%20sem.get(%22warning%22%2C%20brand%5B%22warning%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22text%22%5D%20%3D%20pal.get(%22text-dark%22%2C%20brand%5B%22text%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22muted%22%5D%20%3D%20pal.get(%22text-medium%22%2C%20brand%5B%22muted%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22surface%22%5D%20%3D%20pal.get(%22surface-white%22%2C%20brand%5B%22surface%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22surface_light%22%5D%20%3D%20pal.get(%22surface-light%22%2C%20brand%5B%22surface_light%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20brand%5B%22border%22%5D%20%3D%20pal.get(%22border-gray%22%2C%20brand%5B%22border%22%5D)%0A%20%20%20%20except%20Exception%3A%0A%20%20%20%20%20%20%20%20pass%0A%0A%20%20%20%20def%20hex_to_rgba(hex_color%3A%20str%2C%20alpha%3A%20float)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20hx%20%3D%20hex_color.lstrip('%23')%0A%20%20%20%20%20%20%20%20r%20%3D%20int(hx%5B0%3A2%5D%2C%2016)%0A%20%20%20%20%20%20%20%20g%20%3D%20int(hx%5B2%3A4%5D%2C%2016)%0A%20%20%20%20%20%20%20%20b%20%3D%20int(hx%5B4%3A6%5D%2C%2016)%0A%20%20%20%20%20%20%20%20return%20f%22rgba(%7Br%7D%2C%7Bg%7D%2C%7Bb%7D%2C%7Balpha%7D)%22%0A%0A%20%20%20%20%23%20Provide%20common%20derived%20colors%0A%20%20%20%20brand%5B%22band_fill%22%5D%20%3D%20hex_to_rgba(brand%5B%22muted%22%5D%2C%200.35)%0A%20%20%20%20brand%5B%22band_fill_outer%22%5D%20%3D%20hex_to_rgba(brand%5B%22muted%22%5D%2C%200.15)%0A%20%20%20%20brand%5B%22path_gray%22%5D%20%3D%20%22rgba(0%2C0%2C0%2C0.07)%22%0A%0A%20%20%20%20%23%20Do%20not%20render%20brand%20info%20in%20the%20UI%3B%20return%20palette%20only%0A%20%20%20%20return%20(brand%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20base64%20as%20_base64%2C%20io%20as%20_io%2C%20zipfile%20as%20_zipfile%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "read",
            "version": "0.16.1",
            "serverToken": "unused",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": false, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
